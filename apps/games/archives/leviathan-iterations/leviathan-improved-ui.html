<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leviathan Galaxy - Civilization Meta-Game [Enhanced UI]</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #fff;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            cursor: crosshair;
        }

        #container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .ui-panel {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            border-radius: 8px;
            padding: 15px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        /* ==================== HEADER ==================== */
        #header {
            top: 0;
            left: 0;
            right: 0;
            border-bottom: 2px solid #00ff00;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            border-radius: 0;
        }

        .header-left, .header-right {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .header-title {
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .help-btn {
            padding: 6px 12px;
            background: #00ff00;
            color: #000;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
        }

        .help-btn:hover {
            background: #00dd00;
        }

        /* ==================== TOAST NOTIFICATIONS ==================== */
        #toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 2001;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #00ff00;
            border-radius: 4px;
            padding: 12px 16px;
            font-size: 12px;
            max-width: 350px;
            animation: slideIn 0.3s ease-out;
            pointer-events: auto;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }

        .toast.warning {
            border-color: #ffaa00;
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.3);
        }

        .toast.danger {
            border-color: #ff4444;
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.3);
        }

        .toast.success {
            border-color: #00ff00;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.removing {
            animation: slideOut 0.3s ease-in forwards;
        }

        /* ==================== MINIMAP ==================== */
        #minimap-container {
            position: absolute;
            left: 20px;
            top: 300px;
            width: 150px;
            height: 150px;
            border: 2px solid #00ff00;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 4px;
            z-index: 900;
        }

        #minimap-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .minimap-label {
            position: absolute;
            bottom: 5px;
            left: 5px;
            font-size: 10px;
            color: #888;
        }

        /* ==================== STATS DASHBOARD ==================== */
        #stats-panel {
            right: 20px;
            bottom: 20px;
            border: 2px solid #00ff00;
            width: 300px;
            max-height: 350px;
            z-index: 900;
        }

        .panel-title {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            user-select: none;
        }

        .panel-title:hover {
            color: #00ff00;
        }

        .panel-toggle {
            font-size: 12px;
            margin-left: auto;
        }

        .stats-content {
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #222;
        }

        .stat-label {
            color: #888;
        }

        .stat-value {
            color: #00ff00;
            font-weight: bold;
        }

        .chart-container {
            margin: 10px 0;
            height: 80px;
            border: 1px solid #333;
            border-radius: 2px;
            background: rgba(0, 255, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .chart-bar {
            position: absolute;
            bottom: 0;
            width: 4px;
            background: #00ff00;
            opacity: 0.6;
            border-radius: 1px;
        }

        .leaderboard {
            margin-top: 10px;
        }

        .leaderboard-item {
            padding: 5px;
            margin: 3px 0;
            background: rgba(100, 100, 255, 0.1);
            border-left: 3px solid #00ff00;
            font-size: 10px;
            border-radius: 2px;
        }

        .leaderboard-rank {
            font-weight: bold;
            color: #ffaa00;
            margin-right: 5px;
        }

        /* ==================== INFO PANEL WITH TABS ==================== */
        #info-panel {
            right: 20px;
            top: 80px;
            border: 2px solid #00ff00;
            min-width: 380px;
            max-width: 450px;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 900;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #333;
            margin-bottom: 10px;
            gap: 5px;
        }

        .tab-btn {
            padding: 8px 12px;
            background: rgba(100, 100, 100, 0.3);
            color: #888;
            border: none;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            font-weight: bold;
            border-radius: 4px 4px 0 0;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: rgba(100, 100, 100, 0.5);
            color: #aaa;
        }

        .tab-btn.active {
            background: #00ff00;
            color: #000;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.2s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .search-box {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            background: rgba(0, 100, 100, 0.2);
            border: 1px solid #00ff00;
            color: #fff;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }

        .search-box::placeholder {
            color: #666;
        }

        .civ-filter-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 4px 8px;
            background: rgba(100, 100, 100, 0.3);
            color: #888;
            border: 1px solid #333;
            cursor: pointer;
            font-size: 10px;
            border-radius: 3px;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: rgba(100, 100, 100, 0.5);
            color: #aaa;
        }

        .filter-btn.active {
            background: #00ff00;
            color: #000;
            border-color: #00ff00;
        }

        .info-section {
            font-size: 12px;
            line-height: 1.6;
        }

        .info-divider {
            margin: 10px 0;
            padding-top: 10px;
            border-top: 1px solid #333;
        }

        .civ-info {
            background: rgba(100, 100, 255, 0.1);
            padding: 10px;
            margin: 8px 0;
            border-radius: 4px;
            border-left: 3px solid;
            font-size: 11px;
        }

        .civ-name {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 5px;
        }

        .civ-expanding { border-left-color: #00ff00; }
        .civ-stable { border-left-color: #ffaa00; }
        .civ-declining { border-left-color: #ff4444; }

        /* ==================== RELATIONSHIP GRAPH ==================== */
        #relationship-graph {
            width: 100%;
            height: 200px;
            border: 1px solid #333;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            margin: 10px 0;
        }

        .graph-legend {
            display: flex;
            gap: 15px;
            font-size: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-box {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .legend-trade { background: #00ff00; }
        .legend-conflict { background: #ff4444; }
        .legend-neutral { background: #888888; }
        .legend-alliance { background: #00aaff; }

        /* ==================== TIME CONTROLS ==================== */
        #time-controls {
            left: 20px;
            top: 80px;
            border: 2px solid #00ff00;
            min-width: 200px;
            z-index: 900;
        }

        .speed-btn {
            padding: 8px 15px;
            margin: 5px;
            background: #1a1a2e;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .speed-btn.active {
            background: #00ff00;
            color: #000;
        }

        .speed-btn:hover {
            background: #2a3a4e;
        }

        .speed-btn.active:hover {
            background: #00dd00;
        }

        /* ==================== CONTROLS PANEL ==================== */
        #controls-panel {
            left: 20px;
            bottom: 20px;
            border: 2px solid #00ff00;
            font-size: 12px;
            z-index: 900;
        }

        .control-group {
            margin: 8px 0;
        }

        .control-group-title {
            font-weight: bold;
            color: #00ff00;
            margin-bottom: 4px;
            font-size: 11px;
        }

        .control-item {
            font-size: 11px;
            margin: 2px 0;
            color: #ccc;
        }

        /* ==================== TUTORIAL/HELP MODAL ==================== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            z-index: 3000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #00ff00;
            border-radius: 8px;
            padding: 30px;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 0 40px rgba(0, 255, 0, 0.5);
        }

        .modal-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #00ff00;
        }

        .modal-section {
            margin-bottom: 20px;
        }

        .modal-section-title {
            font-size: 14px;
            font-weight: bold;
            color: #ffaa00;
            margin-bottom: 10px;
        }

        .modal-text {
            font-size: 12px;
            line-height: 1.8;
            color: #ddd;
            margin-bottom: 8px;
        }

        .keybind {
            display: flex;
            gap: 10px;
            margin: 5px 0;
            font-size: 11px;
        }

        .keybind-key {
            background: #1a1a2e;
            padding: 4px 8px;
            border: 1px solid #00ff00;
            border-radius: 3px;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }

        .keybind-desc {
            flex: 1;
            color: #888;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            background: #00ff00;
            color: #000;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .modal-btn:hover {
            background: #00dd00;
        }

        .modal-btn.secondary {
            background: #1a1a2e;
            color: #fff;
            border: 1px solid #00ff00;
        }

        .modal-btn.secondary:hover {
            background: #2a3a4e;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 28px;
            font-weight: bold;
            color: #00ff00;
            cursor: pointer;
            background: none;
            border: none;
        }

        .close-modal:hover {
            color: #00dd00;
        }

        /* ==================== VARIOUS ==================== */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            z-index: 2000;
            text-align: center;
        }

        .zoom-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: #00ff00;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
            text-shadow: 0 0 20px #00ff00;
            text-align: center;
        }

        .zoom-indicator.active {
            opacity: 1;
        }

        .mode-btn {
            padding: 10px 20px;
            background: #ff4400;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 14px;
            margin-top: 10px;
        }

        .mode-btn:hover {
            background: #ff6622;
        }

        #hover-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #00ff00;
            border-radius: 4px;
            padding: 8px;
            font-size: 11px;
            pointer-events: none;
            z-index: 999;
            display: none;
            max-width: 200px;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: #00ff00;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #00dd00;
        }

        /* Tutorial markers for first-time players */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2500;
            display: none;
        }

        .tutorial-overlay.active {
            display: block;
        }

        .tutorial-highlight {
            position: absolute;
            border: 3px solid #00ff00;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.8), inset 0 0 10px rgba(0, 255, 0, 0.3);
            border-radius: 8px;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 0, 0.8), inset 0 0 10px rgba(0, 255, 0, 0.3); }
            50% { box-shadow: 0 0 30px rgba(0, 255, 0, 1), inset 0 0 20px rgba(0, 255, 0, 0.5); }
        }

        .tutorial-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
            max-width: 300px;
            font-size: 12px;
            line-height: 1.6;
            z-index: 2600;
        }
    </style>
</head>
<body>
    <div id="loading">INITIALIZING GALACTIC CIVILIZATION<br/>META-GAME...</div>
    <div id="container"></div>
    <div id="hover-tooltip"></div>

    <div class="zoom-indicator" id="zoomIndicator">‚¨á DESCENDING TO PLANETARY SURFACE ‚¨á</div>

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div id="toast-container"></div>

    <!-- TUTORIAL OVERLAY -->
    <div class="tutorial-overlay" id="tutorialOverlay"></div>

    <!-- Header -->
    <div class="ui-panel" id="header">
        <div class="header-left">
            <div class="header-title">
                <span id="modeIcon">üåå</span>
                <span id="modeTitle">LEVIATHAN GALAXY - CIVILIZATION META-GAME [ENHANCED UI]</span>
            </div>
            <div style="font-size: 12px; color: #888;">
                <span id="modeDisplay">Galaxy View</span>
            </div>
        </div>
        <div class="header-right">
            <div class="stat">
                <span>‚≠ê</span>
                <span id="civCount">0</span>
                <span>Civilizations</span>
            </div>
            <div class="stat">
                <span>üåç</span>
                <span id="planetCount">0</span>
                <span>Planets</span>
            </div>
            <div class="stat">
                <span>‚è±Ô∏è</span>
                <span id="timeDisplay">Cycle 0</span>
            </div>
            <button class="help-btn" onclick="showHelp()">?</button>
        </div>
    </div>

    <!-- MINIMAP -->
    <div id="minimap-container" style="display: none;">
        <canvas id="minimap-canvas"></canvas>
        <div class="minimap-label">MINIMAP</div>
    </div>

    <!-- Time Controls -->
    <div class="ui-panel" id="time-controls">
        <div class="panel-title">‚è±Ô∏è Time Flow</div>
        <div>
            <button class="speed-btn" data-speed="0">‚è∏ Pause</button>
            <button class="speed-btn active" data-speed="1">‚ñ∂ 1x</button>
            <button class="speed-btn" data-speed="2">‚ñ∂‚ñ∂ 2x</button>
            <button class="speed-btn" data-speed="5">‚è© 5x</button>
        </div>
    </div>

    <!-- Info Panel with Tabs -->
    <div class="ui-panel" id="info-panel">
        <div class="tabs">
            <button class="tab-btn active" data-tab="overview">üìä Overview</button>
            <button class="tab-btn" data-tab="civilizations">‚≠ê Civilizations</button>
            <button class="tab-btn" data-tab="relationships">ü§ù Relationships</button>
        </div>

        <!-- Overview Tab -->
        <div class="tab-content active" id="tab-overview">
            <div class="info-section" id="overviewContent">
                Loading...
            </div>
        </div>

        <!-- Civilizations Tab with Search/Filter -->
        <div class="tab-content" id="tab-civilizations">
            <input type="text" class="search-box" id="civSearch" placeholder="Search civilizations...">
            <div class="civ-filter-buttons">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="expanding">Expanding</button>
                <button class="filter-btn" data-filter="stable">Stable</button>
                <button class="filter-btn" data-filter="declining">Declining</button>
            </div>
            <div class="info-section" id="civilizationsContent">
                Loading...
            </div>
        </div>

        <!-- Relationships Tab -->
        <div class="tab-content" id="tab-relationships">
            <canvas id="relationship-graph"></canvas>
            <div class="graph-legend">
                <div class="legend-item">
                    <div class="legend-box legend-trade"></div>
                    <span>Trade</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box legend-alliance"></div>
                    <span>Alliance</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box legend-conflict"></div>
                    <span>Conflict</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box legend-neutral"></div>
                    <span>Neutral</span>
                </div>
            </div>
            <div class="info-section" id="relationshipsContent">
                Loading...
            </div>
        </div>
    </div>

    <!-- Statistics Dashboard -->
    <div class="ui-panel" id="stats-panel">
        <div class="panel-title">üìà Statistics <span class="panel-toggle">‚ñº</span></div>
        <div class="stats-content" id="statsContent">
            <div class="stat-row">
                <span class="stat-label">Total Civilizations</span>
                <span class="stat-value" id="statTotalCivs">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Alive Civilizations</span>
                <span class="stat-value" id="statAliveCivs">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Extinct Civilizations</span>
                <span class="stat-value" id="statExtinctCivs">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Avg Tech Level</span>
                <span class="stat-value" id="statAvgTech">0.0</span>
            </div>
            <div style="margin: 10px 0; padding-top: 10px; border-top: 1px solid #333;">
                <div style="font-weight: bold; color: #00ff00; margin-bottom: 8px;">Civilization History</div>
                <div class="chart-container" id="civChart"></div>
            </div>
            <div style="margin: 10px 0; padding-top: 10px; border-top: 1px solid #333;">
                <div style="font-weight: bold; color: #00ff00; margin-bottom: 8px;">Most Advanced</div>
                <div class="leaderboard" id="leaderboard"></div>
            </div>
        </div>
    </div>

    <!-- Controls Panel -->
    <div class="ui-panel" id="controls-panel">
        <div class="panel-title">üéÆ Controls</div>
        <div class="control-group">
            <div class="control-group-title">Galaxy Mode</div>
            <div class="control-item">W/A/S/D: Move forward/back/left/right</div>
            <div class="control-item">Q/E: Move up/down</div>
            <div class="control-item">Mouse: Hover over planets</div>
            <div class="control-item">Click: Select civilization</div>
            <div class="control-item">Enter: Land on planet</div>
        </div>
        <div class="control-group">
            <div class="control-group-title">Planet Mode</div>
            <div class="control-item">W/A/S/D: Move around</div>
            <div class="control-item">Esc: Return to galaxy</div>
        </div>
    </div>

    <!-- HELP MODAL -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeHelp()">‚úï</button>
            <div class="modal-title">üåå LEVIATHAN GALAXY - HELP & TUTORIAL</div>

            <div class="modal-section">
                <div class="modal-section-title">Welcome, Explorer!</div>
                <div class="modal-text">
                    You are a cosmic observer watching the rise and fall of thousands of civilizations across an infinite galaxy.
                    Navigate through space, discover civilizations, land on worlds, and observe the grand tapestry of galactic history.
                </div>
            </div>

            <div class="modal-section">
                <div class="modal-section-title">Galaxy View Controls</div>
                <div class="keybind">
                    <div class="keybind-key">W / ‚Üë</div>
                    <div class="keybind-desc">Move forward in space</div>
                </div>
                <div class="keybind">
                    <div class="keybind-key">S / ‚Üì</div>
                    <div class="keybind-desc">Move backward in space</div>
                </div>
                <div class="keybind">
                    <div class="keybind-key">A / ‚Üê</div>
                    <div class="keybind-desc">Move left</div>
                </div>
                <div class="keybind">
                    <div class="keybind-key">D / ‚Üí</div>
                    <div class="keybind-desc">Move right</div>
                </div>
                <div class="keybind">
                    <div class="keybind-key">Q</div>
                    <div class="keybind-desc">Move up (z-axis)</div>
                </div>
                <div class="keybind">
                    <div class="keybind-key">E</div>
                    <div class="keybind-desc">Move down (z-axis)</div>
                </div>
                <div class="keybind">
                    <div class="keybind-key">Mouse Move</div>
                    <div class="keybind-desc">Hover over civilizations to see info</div>
                </div>
                <div class="keybind">
                    <div class="keybind-key">Click</div>
                    <div class="keybind-desc">Select a civilization</div>
                </div>
                <div class="keybind">
                    <div class="keybind-key">Enter</div>
                    <div class="keybind-desc">Land on selected civilization's homeworld</div>
                </div>
            </div>

            <div class="modal-section">
                <div class="modal-section-title">Planet Mode Controls</div>
                <div class="keybind">
                    <div class="keybind-key">W/A/S/D</div>
                    <div class="keybind-desc">Move around the planet surface</div>
                </div>
                <div class="keybind">
                    <div class="keybind-key">Escape</div>
                    <div class="keybind-desc">Return to galaxy view</div>
                </div>
            </div>

            <div class="modal-section">
                <div class="modal-section-title">UI Features</div>
                <div class="modal-text">
                    <strong>üåå Galaxy Overview:</strong> See your position and nearby civilizations<br><br>
                    <strong>üìä Statistics:</strong> Track civilization history and view the leaderboard<br><br>
                    <strong>‚≠ê Civilizations Tab:</strong> Search and filter civilizations by status<br><br>
                    <strong>ü§ù Relationships:</strong> Visualize diplomatic connections between major civilizations<br><br>
                    <strong>‚è±Ô∏è Time Controls:</strong> Pause or speed up the simulation<br><br>
                    <strong>üçû Toast Notifications:</strong> Get alerts about major galactic events
                </div>
            </div>

            <div class="modal-section">
                <div class="modal-section-title">Civilization States</div>
                <div class="modal-text">
                    <strong style="color: #00ff00;">EXPANDING:</strong> Young civilizations rapidly growing and colonizing<br><br>
                    <strong style="color: #ffaa00;">STABLE:</strong> Mature civilizations in their prime<br><br>
                    <strong style="color: #ff4444;">DECLINING:</strong> Aging civilizations facing extinction
                </div>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn" onclick="closeHelp()">Got It!</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // ==================== CONSTANTS ====================
        const GALAXY_SIZE = 2000;
        const GALAXY_SPACING = 5000;
        const NUM_CIVILIZATIONS_PER_GALAXY = 50;
        const NUM_STARS_PER_GALAXY = 2000;
        const PLANET_SIZE = 200;
        const CYCLE_DURATION = 2000;
        const SYSTEM_REVEAL_DISTANCE = 500;
        const GALAXY_LOAD_DISTANCE = 8000;

        // ==================== STATE ====================
        let mode = 'galaxy';
        let galaxies = new Map();
        let civilizations = new Map();
        let backgroundStars = [];
        let selectedCiv = null;
        let hoveredCiv = null;
        let galacticCycle = 0;
        let timeSpeed = 1;
        let lastUpdateTime = Date.now();
        let civHistoryChart = [];
        let hasShownTutorial = localStorage.getItem('leviathan_tutorial_shown') === 'true';

        let viewPos = { x: 0, y: 0, z: 300 };
        let viewVelocity = { x: 0, y: 0, z: 0 };
        let mousePos = { x: 0, y: 0 };
        let keys = {};

        let landedPlanet = null;
        let playerPos = { x: 0, y: 0, z: 10 };
        let cameraAngle = { theta: 0, phi: Math.PI / 4 };

        let scene, camera, renderer, animationId;
        let civilizationMeshes = new Map();
        let starField;
        let hoverMarker, selectedMarker;
        let orbitGroups = new Map();
        let visibleSystems = new Set();
        let starSystems = [];
        let blackHoles = new Map();
        let currentCivFilter = 'all';
        let currentCivSearch = '';

        // ==================== TOAST NOTIFICATION SYSTEM ====================
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;

            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function triggerGameEvent(message, type = 'info') {
            showToast(message, type);
        }

        // ==================== MINIMAP ====================
        function updateMinimap() {
            const canvas = document.getElementById('minimap-canvas');
            if (!canvas || mode !== 'galaxy') return;

            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;

            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, w, h);
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 1;
            ctx.strokeRect(0, 0, w, h);

            const scale = 2000;
            const centerX = w / 2;
            const centerY = h / 2;

            // Draw player position
            ctx.fillStyle = '#00ff00';
            ctx.fillRect(centerX - 2, centerY - 2, 4, 4);

            // Draw nearby civilizations
            civilizations.forEach(civ => {
                if (!civ.alive) return;
                const dx = (civ.x - viewPos.x) / scale;
                const dy = (civ.y - viewPos.y) / scale;

                if (Math.abs(dx) < w/2 && Math.abs(dy) < h/2) {
                    ctx.fillStyle = civ.color.getStyle();
                    ctx.globalAlpha = 0.7;
                    ctx.beginPath();
                    ctx.arc(centerX + dx, centerY + dy, 2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.globalAlpha = 1;
                }
            });
        }

        // ==================== CIVILIZATION CLASS ====================
        class Civilization {
            constructor(id, x, y, z, star) {
                this.id = id;
                this.x = x;
                this.y = y;
                this.z = z;
                this.star = star;
                this.age = 0;
                this.population = Math.random() * 5000000 + 1000000;
                this.techLevel = Math.random() * 3 + 1;
                this.planets = 1;
                this.alive = true;
                this.neighbors = 0;
                this.color = new THREE.Color().setHSL(Math.random(), 0.8, 0.6);
                this.lastState = null;

                const philosophies = ['Collectivist', 'Individualist', 'Spiritual', 'Materialist', 'Militarist', 'Pacifist'];
                const governments = ['Democracy', 'Oligarchy', 'Hive Mind', 'Corporate', 'Empire', 'Federation'];
                const adjectives = ['Ancient', 'Zealous', 'Synthetic', 'Harmonious', 'Warlike', 'Mercantile', 'Scientific', 'Mystical'];
                const nouns = ['Imperium', 'Collective', 'Commonwealth', 'Dominion', 'Republic', 'Consortium', 'Alliance', 'Covenant'];

                this.culture = {
                    name: `${adjectives[Math.floor(Math.random() * adjectives.length)]} ${nouns[Math.floor(Math.random() * nouns.length)]}`,
                    philosophy: philosophies[Math.floor(Math.random() * philosophies.length)],
                    governance: governments[Math.floor(Math.random() * governments.length)]
                };
            }

            update() {
                if (!this.alive) return;

                this.age++;
                const oldState = this.getState();

                const growthRate = 1 + (this.techLevel / 100) - (this.neighbors * 0.01);
                this.population *= growthRate;

                this.techLevel += 0.05 * (1 + Math.random() * 0.5);
                this.techLevel = Math.min(10, this.techLevel);

                if (this.techLevel > 5 && Math.random() < 0.05) {
                    this.planets++;
                }

                if (this.population < 100000 || this.age > 500 || Math.random() < 0.001) {
                    this.alive = false;
                    triggerGameEvent(`${this.culture.name} has gone extinct!`, 'danger');
                }

                const newState = this.getState();
                if (newState !== oldState && oldState !== null) {
                    if (newState === 'expanding') {
                        triggerGameEvent(`${this.culture.name} is rapidly expanding!`, 'success');
                    } else if (newState === 'declining') {
                        triggerGameEvent(`${this.culture.name} is in decline.`, 'warning');
                    }
                }
            }

            updatePosition() {
                if (this.star) {
                    this.x = this.star.x;
                    this.y = this.star.y;
                    this.z = this.star.z;
                }
            }

            getState() {
                if (this.age < 50) return 'expanding';
                if (this.age < 300) return 'stable';
                return 'declining';
            }
        }

        // ==================== PLANET CLASS ====================
        class Planet {
            constructor(civilization) {
                this.civilization = civilization;
                this.cities = [];

                const numCities = Math.floor(Math.random() * 5) + 3;
                for (let i = 0; i < numCities; i++) {
                    this.cities.push({
                        x: Math.random() * PLANET_SIZE,
                        z: Math.random() * PLANET_SIZE,
                        height: Math.random() * 3 + 1,
                        size: Math.random() * 5 + 2
                    });
                }
            }
        }

        // ==================== GALAXY CLASS ====================
        class Galaxy {
            constructor(gridX, gridY, gridZ) {
                this.gridX = gridX;
                this.gridY = gridY;
                this.gridZ = gridZ;
                this.centerX = gridX * GALAXY_SPACING;
                this.centerY = gridY * GALAXY_SPACING;
                this.centerZ = gridZ * GALAXY_SPACING;
                this.stars = [];
                this.civilizations = [];
                this.seed = this.hashCoords(gridX, gridY, gridZ);
                this.loaded = false;

                this.color = new THREE.Color().setHSL(this.random() * 0.2, 0.6, 0.6);
                this.size = GALAXY_SIZE * (0.7 + this.random() * 0.6);
                this.numStars = Math.floor(NUM_STARS_PER_GALAXY * (0.5 + this.random()));
                this.numCivs = Math.floor(NUM_CIVILIZATIONS_PER_GALAXY * (0.3 + this.random() * 0.7));
                this.rotationSpeed = 0.00005 + this.random() * 0.00005;
            }

            hashCoords(x, y, z) {
                return ((x * 73856093) ^ (y * 19349663) ^ (z * 83492791)) >>> 0;
            }

            random() {
                this.seed = (this.seed * 1664525 + 1013904223) >>> 0;
                return (this.seed / 4294967296);
            }

            generate() {
                if (this.loaded) return;
                this.loaded = true;

                for (let i = 0; i < this.numStars; i++) {
                    const angle = this.random() * Math.PI * 2;
                    const radius = this.random() * this.size;
                    const x = this.centerX + Math.cos(angle) * radius;
                    const y = this.centerY + Math.sin(angle) * radius;
                    const z = this.centerZ + (this.random() - 0.5) * this.size * 0.3;

                    const orbitalSpeed = this.rotationSpeed / Math.max(radius / this.size, 0.3);

                    const star = {
                        x, y, z,
                        radius: Math.sqrt((x - this.centerX)**2 + (y - this.centerY)**2),
                        angle: Math.atan2(y - this.centerY, x - this.centerX),
                        orbitalSpeed: orbitalSpeed,
                        galaxy: this,
                        hasCivilization: false,
                        civilizationId: null
                    };

                    this.stars.push(star);
                    backgroundStars.push(star);
                }

                const availableStars = [...this.stars];
                for (let i = 0; i < this.numCivs; i++) {
                    if (availableStars.length === 0) break;

                    const starIndex = Math.floor(this.random() * availableStars.length);
                    const star = availableStars[starIndex];
                    availableStars.splice(starIndex, 1);

                    const civId = `${this.gridX}_${this.gridY}_${this.gridZ}_${i}`;
                    const civ = new Civilization(civId, star.x, star.y, star.z, star);
                    civilizations.set(civId, civ);
                    this.civilizations.push(civ);

                    star.hasCivilization = true;
                    star.civilizationId = civId;
                }
            }

            unload() {
                if (!this.loaded) return;
                this.loaded = false;

                this.stars.forEach(star => {
                    const index = backgroundStars.indexOf(star);
                    if (index > -1) backgroundStars.splice(index, 1);
                });

                this.civilizations.forEach(civ => {
                    civilizations.delete(civ.id);
                    orbitGroups.delete(civ.id);
                    civilizationMeshes.delete(civ.id);
                });

                this.stars = [];
                this.civilizations = [];
            }
        }

        // ==================== GALAXY INITIALIZATION ====================
        function initializeGalaxy() {
            updateLoadedGalaxies();

            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                if (!hasShownTutorial) {
                    showHelp();
                    localStorage.setItem('leviathan_tutorial_shown', 'true');
                }
            }, 1000);
        }

        function getGalaxyCoords(x, y, z) {
            return {
                gridX: Math.floor(x / GALAXY_SPACING),
                gridY: Math.floor(y / GALAXY_SPACING),
                gridZ: Math.floor(z / GALAXY_SPACING)
            };
        }

        function getGalaxyKey(gridX, gridY, gridZ) {
            return `${gridX},${gridY},${gridZ}`;
        }

        function updateLoadedGalaxies() {
            const playerCoords = getGalaxyCoords(viewPos.x, viewPos.y, viewPos.z);
            const loadRadius = 1;

            const shouldBeLoaded = new Set();

            for (let dx = -loadRadius; dx <= loadRadius; dx++) {
                for (let dy = -loadRadius; dy <= loadRadius; dy++) {
                    for (let dz = -loadRadius; dz <= loadRadius; dz++) {
                        const gridX = playerCoords.gridX + dx;
                        const gridY = playerCoords.gridY + dy;
                        const gridZ = playerCoords.gridZ + dz;
                        const key = getGalaxyKey(gridX, gridY, gridZ);
                        shouldBeLoaded.add(key);

                        if (!galaxies.has(key)) {
                            const galaxy = new Galaxy(gridX, gridY, gridZ);
                            galaxies.set(key, galaxy);
                        }

                        const galaxy = galaxies.get(key);
                        if (!galaxy.loaded) {
                            galaxy.generate();
                        }
                    }
                }
            }

            galaxies.forEach((galaxy, key) => {
                if (!shouldBeLoaded.has(key) && galaxy.loaded) {
                    galaxy.unload();
                }
            });
        }

        // ==================== THREE.JS SETUP ====================
        function initThreeJS() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 10000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000);
            document.getElementById('container').appendChild(renderer.domElement);

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // ==================== GALAXY RENDERING ====================
        function renderGalaxy() {
            scene.clear();
            civilizationMeshes.clear();
            starSystems = [];
            blackHoles.clear();

            galaxies.forEach(galaxy => {
                if (!galaxy.loaded) return;

                const blackHoleGeometry = new THREE.SphereGeometry(20, 32, 32);
                const blackHoleMaterial = new THREE.MeshBasicMaterial({ color: 0x000000 });
                const blackHole = new THREE.Mesh(blackHoleGeometry, blackHoleMaterial);
                blackHole.position.set(galaxy.centerX, galaxy.centerY, galaxy.centerZ);
                scene.add(blackHole);

                const horizonGeometry = new THREE.SphereGeometry(25, 32, 32);
                const horizonMaterial = new THREE.MeshBasicMaterial({
                    color: galaxy.color,
                    transparent: true,
                    opacity: 0.3
                });
                const horizon = new THREE.Mesh(horizonGeometry, horizonMaterial);
                horizon.position.set(galaxy.centerX, galaxy.centerY, galaxy.centerZ);
                scene.add(horizon);

                const diskGeometry = new THREE.RingGeometry(25, 50, 64);
                const diskMaterial = new THREE.MeshBasicMaterial({
                    color: galaxy.color,
                    transparent: true,
                    opacity: 0.4,
                    side: THREE.DoubleSide
                });
                const disk = new THREE.Mesh(diskGeometry, diskMaterial);
                disk.position.set(galaxy.centerX, galaxy.centerY, galaxy.centerZ);
                disk.rotation.x = Math.PI / 2;
                scene.add(disk);

                blackHoles.set(getGalaxyKey(galaxy.gridX, galaxy.gridY, galaxy.gridZ), {
                    blackHole, horizon, disk
                });
            });

            const starGeometry = new THREE.BufferGeometry();
            const starVertices = [];
            const starColors = [];

            backgroundStars.forEach(star => {
                starVertices.push(star.x, star.y, star.z);

                if (star.hasCivilization) {
                    const warmColor = new THREE.Color(0xffffdd);
                    starColors.push(warmColor.r, warmColor.g, warmColor.b);
                } else {
                    const coolColor = new THREE.Color(0xaaaaaa);
                    starColors.push(coolColor.r, coolColor.g, coolColor.b);
                }
            });

            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
            starGeometry.setAttribute('color', new THREE.Float32BufferAttribute(starColors, 3));

            const starMaterial = new THREE.PointsMaterial({
                size: 4,
                vertexColors: true,
                sizeAttenuation: true
            });
            starField = new THREE.Points(starGeometry, starMaterial);
            scene.add(starField);

            const hoverGeometry = new THREE.RingGeometry(8, 10, 32);
            const hoverMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff, side: THREE.DoubleSide });
            hoverMarker = new THREE.Mesh(hoverGeometry, hoverMaterial);
            hoverMarker.visible = false;
            scene.add(hoverMarker);

            const selectedGeometry = new THREE.RingGeometry(10, 13, 32);
            const selectedMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff00, side: THREE.DoubleSide });
            selectedMarker = new THREE.Mesh(selectedGeometry, selectedMaterial);
            selectedMarker.visible = false;
            scene.add(selectedMarker);

            updateCamera();
            updateVisibleSystems();
        }

        function updateVisibleSystems() {
            const newVisibleSystems = new Set();

            civilizations.forEach(civ => {
                if (!civ.alive) return;

                const dist = Math.sqrt(
                    (civ.x - viewPos.x)**2 +
                    (civ.y - viewPos.y)**2 +
                    (civ.z - viewPos.z)**2
                );

                if (dist < SYSTEM_REVEAL_DISTANCE) {
                    newVisibleSystems.add(civ.id);

                    if (!orbitGroups.has(civ.id)) {
                        createOrbitSystem(civ);
                    }
                }
            });

            orbitGroups.forEach((orbitGroup, civId) => {
                if (!newVisibleSystems.has(civId)) {
                    scene.remove(orbitGroup);
                    orbitGroups.delete(civId);
                    civilizationMeshes.delete(civId);
                }
            });

            visibleSystems = newVisibleSystems;
        }

        function createOrbitSystem(civ) {
            const orbitGroup = new THREE.Group();
            orbitGroup.position.set(civ.x, civ.y, civ.z);
            scene.add(orbitGroup);
            orbitGroups.set(civ.id, orbitGroup);

            const numPlanets = Math.min(civ.planets, 3);
            for (let p = 0; p < numPlanets; p++) {
                const orbitRadius = 15 + (p * 10);
                const size = Math.log(civ.population / 100000) * 3 - (p * 0.5);

                const geometry = new THREE.SphereGeometry(Math.max(size, 3), 16, 16);
                const material = new THREE.MeshBasicMaterial({ color: civ.color });
                const planet = new THREE.Mesh(geometry, material);

                const startAngle = (p * Math.PI * 2 / numPlanets) + (civ.id * 0.5);
                planet.position.set(
                    Math.cos(startAngle) * orbitRadius,
                    Math.sin(startAngle) * orbitRadius,
                    0
                );

                planet.userData.civilization = civ;
                planet.userData.orbitRadius = orbitRadius;
                planet.userData.orbitSpeed = 0.001 / (1 + p * 0.5);
                planet.userData.currentAngle = startAngle;
                planet.userData.isPrimary = (p === 0);

                orbitGroup.add(planet);

                if (p === 0) {
                    civilizationMeshes.set(civ.id, planet);
                }

                const glowGeometry = new THREE.SphereGeometry(Math.max(size, 3) * 1.5, 16, 16);
                const glowMaterial = new THREE.MeshBasicMaterial({
                    color: civ.color,
                    transparent: true,
                    opacity: 0.3
                });
                const glowMesh = new THREE.Mesh(glowGeometry, glowMaterial);
                glowMesh.position.copy(planet.position);
                planet.userData.glow = glowMesh;
                orbitGroup.add(glowMesh);

                const orbitCurve = new THREE.EllipseCurve(
                    0, 0,
                    orbitRadius, orbitRadius,
                    0, 2 * Math.PI,
                    false,
                    0
                );
                const orbitPoints = orbitCurve.getPoints(50);
                const orbitGeometry = new THREE.BufferGeometry().setFromPoints(orbitPoints);
                const orbitMaterial = new THREE.LineBasicMaterial({
                    color: 0x444444,
                    transparent: true,
                    opacity: 0.5
                });
                const orbitLine = new THREE.Line(orbitGeometry, orbitMaterial);
                orbitLine.rotation.x = Math.PI / 2;
                orbitGroup.add(orbitLine);
            }
        }

        function updateCamera() {
            camera.position.set(viewPos.x, viewPos.y, viewPos.z);
            camera.lookAt(viewPos.x, viewPos.y, viewPos.z - 100);
        }

        // ==================== PLANET RENDERING ====================
        function renderPlanet() {
            scene.clear();

            const groundGeometry = new THREE.PlaneGeometry(PLANET_SIZE, PLANET_SIZE, 50, 50);
            const vertices = groundGeometry.attributes.position.array;
            for (let i = 0; i < vertices.length; i += 3) {
                vertices[i + 2] = Math.random() * 2;
            }
            groundGeometry.attributes.position.needsUpdate = true;
            groundGeometry.computeVertexNormals();

            const groundMaterial = new THREE.MeshBasicMaterial({
                color: 0x2a4a2a,
                wireframe: true
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            scene.add(ground);

            landedPlanet.cities.forEach(city => {
                const geometry = new THREE.BoxGeometry(city.size, city.height, city.size);
                const material = new THREE.MeshBasicMaterial({ color: 0x00aaff });
                const building = new THREE.Mesh(geometry, material);
                building.position.set(city.x - PLANET_SIZE/2, city.height/2, city.z - PLANET_SIZE/2);
                scene.add(building);
            });

            const gridHelper = new THREE.GridHelper(PLANET_SIZE, 20, 0x444444, 0x222222);
            scene.add(gridHelper);
        }

        // ==================== ANIMATION ====================
        let lastGalaxyUpdatePos = { x: 0, y: 0, z: 0 };

        function animate() {
            animationId = requestAnimationFrame(animate);

            const now = Date.now();
            if (now - lastUpdateTime > CYCLE_DURATION / timeSpeed && timeSpeed > 0) {
                galacticCycle++;
                civilizations.forEach(civ => civ.update());
                lastUpdateTime = now;
                updateUI();
            }

            if (mode === 'galaxy') {
                viewPos.x += viewVelocity.x;
                viewPos.y += viewVelocity.y;
                viewPos.z += viewVelocity.z;

                viewVelocity.x *= 0.95;
                viewVelocity.y *= 0.95;
                viewVelocity.z *= 0.95;

                const moveSpeed = 2;
                if (keys['w'] || keys['ArrowUp']) viewVelocity.z -= moveSpeed;
                if (keys['s'] || keys['ArrowDown']) viewVelocity.z += moveSpeed;
                if (keys['a'] || keys['ArrowLeft']) viewVelocity.x -= moveSpeed;
                if (keys['d'] || keys['ArrowRight']) viewVelocity.x += moveSpeed;
                if (keys['q']) viewVelocity.y += moveSpeed;
                if (keys['e']) viewVelocity.y -= moveSpeed;

                const distMoved = Math.sqrt(
                    (viewPos.x - lastGalaxyUpdatePos.x)**2 +
                    (viewPos.y - lastGalaxyUpdatePos.y)**2 +
                    (viewPos.z - lastGalaxyUpdatePos.z)**2
                );
                if (distMoved > GALAXY_SPACING / 2) {
                    updateLoadedGalaxies();
                    lastGalaxyUpdatePos = { ...viewPos };
                    renderGalaxy();
                }

                backgroundStars.forEach(star => {
                    if (!star.galaxy) return;

                    star.angle += star.orbitalSpeed * timeSpeed;
                    star.x = star.galaxy.centerX + Math.cos(star.angle) * star.radius;
                    star.y = star.galaxy.centerY + Math.sin(star.angle) * star.radius;
                });

                if (starField && starField.geometry.attributes.position) {
                    const positions = starField.geometry.attributes.position.array;
                    backgroundStars.forEach((star, i) => {
                        if (i * 3 + 2 < positions.length) {
                            positions[i * 3] = star.x;
                            positions[i * 3 + 1] = star.y;
                            positions[i * 3 + 2] = star.z;
                        }
                    });
                    starField.geometry.attributes.position.needsUpdate = true;
                }

                civilizations.forEach(civ => civ.updatePosition());

                updateCamera();
                updateVisibleSystems();
                updateMinimap();

                orbitGroups.forEach((orbitGroup, civId) => {
                    const civ = civilizations.get(civId);
                    if (civ) {
                        orbitGroup.position.set(civ.x, civ.y, civ.z);
                    }

                    orbitGroup.children.forEach(child => {
                        if (child.userData.orbitRadius) {
                            child.userData.currentAngle += child.userData.orbitSpeed * timeSpeed;

                            const radius = child.userData.orbitRadius;
                            child.position.x = Math.cos(child.userData.currentAngle) * radius;
                            child.position.y = Math.sin(child.userData.currentAngle) * radius;

                            if (child.userData.glow) {
                                child.userData.glow.position.copy(child.position);
                            }
                        }
                    });
                });
            } else if (mode === 'planet') {
                const distance = 30;
                camera.position.set(
                    playerPos.x - PLANET_SIZE/2 + Math.cos(cameraAngle.theta) * distance,
                    playerPos.z + 15,
                    playerPos.y - PLANET_SIZE/2 + Math.sin(cameraAngle.theta) * distance
                );
                camera.lookAt(playerPos.x - PLANET_SIZE/2, playerPos.z, playerPos.y - PLANET_SIZE/2);
            }

            renderer.render(scene, camera);
        }

        // ==================== MOVEMENT ====================
        function movePlayer(dx, dy) {
            const speed = 2;
            playerPos.x += dx * speed;
            playerPos.y += dy * speed;
            playerPos.x = Math.max(0, Math.min(PLANET_SIZE, playerPos.x));
            playerPos.y = Math.max(0, Math.min(PLANET_SIZE, playerPos.y));
            updateUI();
        }

        // ==================== MODE SWITCHING ====================
        function descendToPlanet(civ) {
            const zoomIndicator = document.getElementById('zoomIndicator');
            zoomIndicator.classList.add('active');

            setTimeout(() => {
                mode = 'planet';
                landedPlanet = new Planet(civ);

                const city = landedPlanet.cities[0];
                if (city) {
                    playerPos = { x: city.x, y: city.z, z: city.height + 2 };
                } else {
                    playerPos = { x: PLANET_SIZE / 2, y: PLANET_SIZE / 2, z: 15 };
                }

                if (animationId) cancelAnimationFrame(animationId);
                const container = document.getElementById('container');
                container.innerHTML = '';
                initThreeJS();
                renderPlanet();
                animate();
                updateUI();

                zoomIndicator.classList.remove('active');
                triggerGameEvent(`Landed on ${civ.culture.name}'s homeworld!`, 'success');
            }, 500);
        }

        function ascendToGalaxy() {
            const zoomIndicator = document.getElementById('zoomIndicator');
            zoomIndicator.textContent = '‚¨Ü ASCENDING TO GALAXY VIEW ‚¨Ü';
            zoomIndicator.classList.add('active');

            setTimeout(() => {
                mode = 'galaxy';
                landedPlanet = null;

                if (animationId) cancelAnimationFrame(animationId);
                const container = document.getElementById('container');
                container.innerHTML = '';
                initThreeJS();
                renderGalaxy();
                animate();
                updateUI();

                zoomIndicator.classList.remove('active');
                zoomIndicator.textContent = '‚¨á DESCENDING TO PLANETARY SURFACE ‚¨á';
                triggerGameEvent('Ascended to galaxy view.', 'info');
            }, 500);
        }

        // ==================== UI UPDATE WITH TABS & STATS ====================
        function updateUI() {
            const aliveCivs = Array.from(civilizations.values()).filter(c => c.alive).length;
            const totalCivs = civilizations.size;
            const extinctCivs = totalCivs - aliveCivs;

            document.getElementById('civCount').textContent = aliveCivs;
            document.getElementById('planetCount').textContent = Array.from(civilizations.values()).reduce((sum, c) => sum + (c.alive ? c.planets : 0), 0);
            document.getElementById('timeDisplay').textContent = `Cycle ${galacticCycle}`;

            document.getElementById('modeIcon').textContent = mode === 'galaxy' ? 'üåå' : 'üåç';
            document.getElementById('modeDisplay').textContent = mode === 'galaxy' ? 'Galaxy View' : 'Planet Surface';

            // Update stats panel
            if (mode === 'galaxy') {
                document.getElementById('statTotalCivs').textContent = totalCivs;
                document.getElementById('statAliveCivs').textContent = aliveCivs;
                document.getElementById('statExtinctCivs').textContent = extinctCivs;

                const avgTech = aliveCivs > 0
                    ? (Array.from(civilizations.values()).filter(c => c.alive).reduce((sum, c) => sum + c.techLevel, 0) / aliveCivs).toFixed(1)
                    : '0.0';
                document.getElementById('statAvgTech').textContent = avgTech;

                // Update civilization history chart
                civHistoryChart.push(aliveCivs);
                if (civHistoryChart.length > 20) civHistoryChart.shift();
                updateCivChart();

                // Update leaderboard
                const topCivs = Array.from(civilizations.values())
                    .filter(c => c.alive)
                    .sort((a, b) => b.techLevel - a.techLevel)
                    .slice(0, 5);

                let leaderboardHTML = '';
                topCivs.forEach((civ, idx) => {
                    leaderboardHTML += `
                        <div class="leaderboard-item">
                            <span class="leaderboard-rank">#${idx + 1}</span>
                            <span style="color: ${civ.color.getStyle()};">${civ.culture.name}</span>
                            <span style="color: #888;">Tech: ${civ.techLevel.toFixed(1)}/10</span>
                        </div>
                    `;
                });
                document.getElementById('leaderboard').innerHTML = leaderboardHTML || '<div style="color: #666;">No civilizations yet...</div>';
            }

            // Update tabs based on mode
            if (mode === 'galaxy') {
                updateOverviewTab();
                updateCivilizationsTab();
                updateRelationshipsTab();
                document.getElementById('minimap-container').style.display = 'block';
            } else {
                document.getElementById('minimap-container').style.display = 'none';
            }
        }

        function updateCivChart() {
            const chartContainer = document.getElementById('civChart');
            chartContainer.innerHTML = '';

            if (civHistoryChart.length === 0) return;

            const maxValue = Math.max(...civHistoryChart, 1);
            const barWidth = chartContainer.offsetWidth / civHistoryChart.length;
            const chartHeight = chartContainer.offsetHeight;

            civHistoryChart.forEach((count, idx) => {
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = (count / maxValue * chartHeight) + 'px';
                bar.style.left = (idx * barWidth) + 'px';
                bar.style.width = barWidth + 'px';
                chartContainer.appendChild(bar);
            });
        }

        function updateOverviewTab() {
            const coords = getGalaxyCoords(viewPos.x, viewPos.y, viewPos.z);
            const loadedGalaxies = Array.from(galaxies.values()).filter(g => g.loaded).length;

            let html = `
                <div>Position: (${Math.floor(viewPos.x)}, ${Math.floor(viewPos.y)}, ${Math.floor(viewPos.z)})</div>
                <div>Galaxy: (${coords.gridX}, ${coords.gridY}, ${coords.gridZ})</div>
                <div>Loaded Galaxies: ${loadedGalaxies}</div>
                <div>Visible Systems: ${visibleSystems.size}</div>
                <div>Time Speed: ${timeSpeed === 0 ? 'PAUSED' : timeSpeed + 'x'}</div>
            `;

            if (selectedCiv) {
                const state = selectedCiv.getState();
                html += `
                    <div class="info-divider">
                        <div class="civ-info civ-${state}">
                            <div class="civ-name">${selectedCiv.culture.name}</div>
                            <div>Age: ${selectedCiv.age} cycles</div>
                            <div>Population: ${(selectedCiv.population / 1000000).toFixed(1)}M</div>
                            <div>Tech Level: ${selectedCiv.techLevel.toFixed(1)}/10</div>
                            <div>Planets: ${selectedCiv.planets}</div>
                            <div>State: ${state.toUpperCase()}</div>
                            <div>Neighbors: ${selectedCiv.neighbors}</div>
                            <div style="margin-top: 5px; font-size: 10px; color: #888;">
                                ${selectedCiv.culture.philosophy} ‚Ä¢ ${selectedCiv.culture.governance}
                            </div>
                            <button class="mode-btn" onclick="descendToPlanet(selectedCiv)" style="width: 100%;">
                                üåç LAND ON HOMEWORLD
                            </button>
                        </div>
                    </div>
                `;
            }

            const nearby = Array.from(civilizations.values())
                .filter(c => c.alive)
                .sort((a, b) => {
                    const distA = Math.sqrt((a.x - viewPos.x)**2 + (a.y - viewPos.y)**2 + (a.z - viewPos.z)**2);
                    const distB = Math.sqrt((b.x - viewPos.x)**2 + (b.y - viewPos.y)**2 + (b.z - viewPos.z)**2);
                    return distA - distB;
                })
                .slice(0, 5);

            if (nearby.length > 0) {
                html += `<div class="info-divider"><div style="font-weight: bold;">Nearby Civilizations:</div>`;
                nearby.forEach(civ => {
                    const dist = Math.sqrt((civ.x - viewPos.x)**2 + (civ.y - viewPos.y)**2 + (civ.z - viewPos.z)**2);
                    html += `<div style="font-size: 11px; margin: 3px 0;">
                        ${civ.culture.name} - ${Math.floor(dist)} units
                    </div>`;
                });
                html += '</div>';
            }

            document.getElementById('overviewContent').innerHTML = html;
        }

        function updateCivilizationsTab() {
            const searchTerm = document.getElementById('civSearch').value.toLowerCase();

            let civList = Array.from(civilizations.values()).filter(c => c.alive);

            if (currentCivFilter !== 'all') {
                civList = civList.filter(c => c.getState() === currentCivFilter);
            }

            if (searchTerm) {
                civList = civList.filter(c => c.culture.name.toLowerCase().includes(searchTerm));
            }

            civList.sort((a, b) => b.techLevel - a.techLevel);
            civList = civList.slice(0, 15);

            let html = '';
            civList.forEach(civ => {
                const state = civ.getState();
                html += `
                    <div class="civ-info civ-${state}" onclick="selectCivFromList('${civ.id}')" style="cursor: pointer;">
                        <div class="civ-name">${civ.culture.name}</div>
                        <div>Tech: ${civ.techLevel.toFixed(1)}/10 | Pop: ${(civ.population / 1000000).toFixed(1)}M</div>
                        <div style="font-size: 10px; color: #888;">${civ.culture.governance} ‚Ä¢ ${civ.culture.philosophy}</div>
                    </div>
                `;
            });

            document.getElementById('civilizationsContent').innerHTML = html || '<div style="color: #666;">No civilizations found.</div>';
        }

        function updateRelationshipsTab() {
            const canvas = document.getElementById('relationship-graph');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;

            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(0, 0, w, h);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.strokeRect(0, 0, w, h);

            const topCivs = Array.from(civilizations.values())
                .filter(c => c.alive)
                .sort((a, b) => b.techLevel - a.techLevel)
                .slice(0, 8);

            if (topCivs.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '12px Courier New';
                ctx.fillText('No civilizations to display', w/2 - 80, h/2);
                return;
            }

            const angleStep = (Math.PI * 2) / topCivs.length;
            const radius = Math.min(w, h) / 3;
            const centerX = w / 2;
            const centerY = h / 2;

            const positions = topCivs.map((civ, idx) => ({
                x: centerX + Math.cos(idx * angleStep) * radius,
                y: centerY + Math.sin(idx * angleStep) * radius,
                civ: civ
            }));

            // Draw connections
            positions.forEach((pos1, idx1) => {
                positions.slice(idx1 + 1).forEach(pos2 => {
                    const tech1 = pos1.civ.techLevel;
                    const tech2 = pos2.civ.techLevel;

                    let color, relationship;
                    if (Math.abs(tech1 - tech2) < 1) {
                        color = '#00ff00';
                        relationship = 'trade';
                    } else if (tech1 > tech2 * 2 || tech2 > tech1 * 2) {
                        color = '#ff4444';
                        relationship = 'conflict';
                    } else {
                        color = '#888888';
                        relationship = 'neutral';
                    }

                    ctx.strokeStyle = color;
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(pos1.x, pos1.y);
                    ctx.lineTo(pos2.x, pos2.y);
                    ctx.stroke();
                });
            });

            // Draw nodes
            positions.forEach(pos => {
                ctx.fillStyle = pos.civ.color.getStyle();
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, 5, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#fff';
                ctx.font = 'bold 10px Courier New';
                ctx.textAlign = 'center';
                ctx.fillText(pos.civ.culture.name.split(' ')[0], pos.x, pos.y + 15);
            });

            let relationshipsHTML = '<div style="font-size: 10px; margin-top: 10px;">';
            const uniquePairs = new Set();
            positions.forEach((pos1, idx1) => {
                positions.slice(idx1 + 1).forEach(pos2 => {
                    const tech1 = pos1.civ.techLevel;
                    const tech2 = pos2.civ.techLevel;
                    let type = '';

                    if (Math.abs(tech1 - tech2) < 1) {
                        type = 'Trade Route';
                    } else if (tech1 > tech2 * 1.5 || tech2 > tech1 * 1.5) {
                        type = 'Conflict Zone';
                    } else {
                        type = 'Neutral Zone';
                    }

                    uniquePairs.add(`${pos1.civ.culture.name} ‚Üî ${pos2.civ.culture.name}: ${type}`);
                });
            });

            Array.from(uniquePairs).slice(0, 5).forEach(pair => {
                relationshipsHTML += `<div style="margin: 3px 0;">${pair}</div>`;
            });
            relationshipsHTML += '</div>';

            document.getElementById('relationshipsContent').innerHTML = relationshipsHTML;
        }

        function selectCivFromList(civId) {
            selectedCiv = civilizations.get(civId);
            updateUI();
            document.querySelector('.tab-btn[data-tab="overview"]').click();
        }

        // ==================== HELP/TUTORIAL ====================
        function showHelp() {
            document.getElementById('helpModal').classList.add('active');
        }

        function closeHelp() {
            document.getElementById('helpModal').classList.remove('active');
        }

        // ==================== HOVER DETECTION ====================
        function findNearestCivilization(mousePos) {
            if (!camera) return null;

            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mousePos, camera);

            const allPlanets = [];
            orbitGroups.forEach((orbitGroup) => {
                orbitGroup.updateMatrixWorld(true);
                orbitGroup.children.forEach(child => {
                    if (child.userData.civilization && child.userData.isPrimary) {
                        allPlanets.push(child);
                    }
                });
            });

            const intersects = raycaster.intersectObjects(allPlanets, false);

            if (intersects.length > 0 && intersects[0].object.userData.civilization) {
                return intersects[0].object.userData.civilization;
            }
            return null;
        }

        function updateHoverMarker() {
            if (hoveredCiv && hoverMarker) {
                hoverMarker.position.set(hoveredCiv.x, hoveredCiv.y, 0);
                hoverMarker.visible = true;
            } else if (hoverMarker) {
                hoverMarker.visible = false;
            }
        }

        function updateSelectedMarker() {
            if (selectedCiv && selectedMarker) {
                selectedMarker.position.set(selectedCiv.x, selectedCiv.y, 0);
                selectedMarker.visible = true;
            } else if (selectedMarker) {
                selectedMarker.visible = false;
            }
        }

        // ==================== INPUT HANDLING ====================
        function handleKeyDown(e) {
            keys[e.key] = true;

            if (mode === 'galaxy') {
                if (e.key === 'Enter' && selectedCiv) {
                    descendToPlanet(selectedCiv);
                }
            } else if (mode === 'planet') {
                switch(e.key) {
                    case 'ArrowUp':
                    case 'w':
                        movePlayer(0, -1);
                        break;
                    case 'ArrowDown':
                    case 's':
                        movePlayer(0, 1);
                        break;
                    case 'ArrowLeft':
                    case 'a':
                        movePlayer(-1, 0);
                        break;
                    case 'ArrowRight':
                    case 'd':
                        movePlayer(1, 0);
                        break;
                    case 'Escape':
                        ascendToGalaxy();
                        break;
                }
            }
        }

        function handleKeyUp(e) {
            keys[e.key] = false;
        }

        function handleMouseMove(e) {
            if (mode !== 'galaxy') return;

            mousePos.x = (e.clientX / window.innerWidth) * 2 - 1;
            mousePos.y = -(e.clientY / window.innerHeight) * 2 + 1;

            const nearest = findNearestCivilization(mousePos);

            if (nearest !== hoveredCiv) {
                hoveredCiv = nearest;
                updateHoverMarker();

                const tooltip = document.getElementById('hover-tooltip');
                if (hoveredCiv) {
                    tooltip.style.display = 'block';
                    tooltip.style.left = e.clientX + 15 + 'px';
                    tooltip.style.top = e.clientY + 15 + 'px';
                    tooltip.innerHTML = `
                        <div style="font-weight: bold; color: ${hoveredCiv.color.getStyle()};">${hoveredCiv.culture.name}</div>
                        <div>Pop: ${(hoveredCiv.population / 1000000).toFixed(1)}M</div>
                        <div>Tech: ${hoveredCiv.techLevel.toFixed(1)}/10</div>
                        <div style="font-size: 10px; color: #888; margin-top: 3px;">Click to select</div>
                    `;
                } else {
                    tooltip.style.display = 'none';
                }
            }
        }

        function handleClick(e) {
            if (mode !== 'galaxy') return;

            if (hoveredCiv) {
                selectedCiv = hoveredCiv;
                updateSelectedMarker();
                updateUI();
            }
        }

        // ==================== INITIALIZATION ====================
        function init() {
            initializeGalaxy();
            initThreeJS();
            renderGalaxy();
            animate();
            updateUI();

            window.addEventListener('keydown', handleKeyDown);
            window.addEventListener('keyup', handleKeyUp);
            window.addEventListener('mousemove', handleMouseMove);
            window.addEventListener('click', handleClick);

            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
                });
            });

            // Civilization filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentCivFilter = btn.dataset.filter;
                    updateCivilizationsTab();
                });
            });

            // Search box
            document.getElementById('civSearch').addEventListener('input', (e) => {
                currentCivSearch = e.target.value;
                updateCivilizationsTab();
            });

            // Speed buttons
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    timeSpeed = parseInt(btn.dataset.speed);
                    document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updateUI();
                });
            });

            // Stats panel toggle
            document.querySelector('#stats-panel .panel-title').addEventListener('click', function() {
                const content = document.getElementById('statsContent');
                const toggle = this.querySelector('.panel-toggle');
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    toggle.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    toggle.textContent = '‚ñ∂';
                }
            });

            window.descendToPlanet = descendToPlanet;
            window.ascendToGalaxy = ascendToGalaxy;
            window.showHelp = showHelp;
            window.closeHelp = closeHelp;
            window.selectCivFromList = selectCivFromList;
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
