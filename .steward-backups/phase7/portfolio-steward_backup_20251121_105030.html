<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Steward - Investment Management</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #2d3748;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px 35px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .portfolio-value {
            font-size: 32px;
            font-weight: 700;
            color: #2d3748;
        }

        .portfolio-change {
            font-size: 16px;
            font-weight: 600;
            padding: 6px 14px;
            border-radius: 8px;
            display: inline-block;
        }

        .portfolio-change.positive {
            background: #c6f6d5;
            color: #22543d;
        }

        .portfolio-change.negative {
            background: #fed7d7;
            color: #742a2a;
        }

        .header-right {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border-radius: 50%;
            background: white;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-icon:hover {
            border-color: #667eea;
            color: #667eea;
            transform: scale(1.1);
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        @media (max-width: 1200px) {
            .grid-3 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .grid, .grid-3 {
                grid-template-columns: 1fr;
            }
        }

        /* Card */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
        }

        .card-action {
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .card-action:hover {
            color: #764ba2;
        }

        /* Asset Card */
        .asset-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .asset-card:hover {
            background: #edf2f7;
            transform: translateX(5px);
        }

        .asset-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }

        .asset-info {
            flex: 1;
        }

        .asset-name {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .asset-symbol {
            font-size: 13px;
            color: #718096;
        }

        .asset-value {
            text-align: right;
        }

        .asset-price {
            font-size: 16px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .asset-change {
            font-size: 13px;
            font-weight: 600;
        }

        .asset-change.positive {
            color: #38a169;
        }

        .asset-change.negative {
            color: #e53e3e;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f7fafc;
            border-radius: 12px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        /* 3D Visualization */
        .viz-container {
            position: relative;
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 20px;
        }

        #viz-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .viz-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 12px;
            font-size: 14px;
            pointer-events: none;
        }

        .viz-overlay-title {
            font-weight: 700;
            margin-bottom: 8px;
            color: #2d3748;
        }

        .viz-overlay-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        /* Transaction List */
        .transaction-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f7fafc;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-type {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .transaction-date {
            font-size: 12px;
            color: #718096;
        }

        .transaction-amount {
            text-align: right;
        }

        .transaction-value {
            font-size: 16px;
            font-weight: 700;
            color: #2d3748;
        }

        .transaction-badge {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 4px;
            display: inline-block;
        }

        .transaction-badge.buy {
            background: #c6f6d5;
            color: #22543d;
        }

        .transaction-badge.sell {
            background: #fed7d7;
            color: #742a2a;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 35px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 25px;
            color: #2d3748;
        }

        .modal-body {
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* AI Assistant Panel */
        .ai-assistant {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            z-index: 999;
            color: white;
            font-size: 28px;
        }

        .ai-assistant:hover {
            transform: scale(1.15);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }

        .ai-assistant.active {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .ai-chat-panel {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 400px;
            max-height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            z-index: 998;
        }

        .ai-chat-panel.active {
            display: flex;
        }

        .ai-chat-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 700;
            color: #2d3748;
        }

        .ai-chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: 400px;
        }

        .ai-message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.6;
        }

        .ai-message.user {
            background: #667eea;
            color: white;
            margin-left: 40px;
        }

        .ai-message.assistant {
            background: #f7fafc;
            color: #2d3748;
            margin-right: 40px;
        }

        .ai-chat-input {
            padding: 15px 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
        }

        .ai-chat-input input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
        }

        .ai-chat-input input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Alerts & Notifications */
        .alert {
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .alert-icon {
            font-size: 20px;
        }

        .alert-info {
            background: #bee3f8;
            color: #2c5282;
        }

        .alert-warning {
            background: #feebc8;
            color: #7c2d12;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            font-weight: 600;
            color: #718096;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab:hover {
            color: #667eea;
        }

        /* Allocation Pie */
        .allocation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .allocation-item:last-child {
            border-bottom: none;
        }

        .allocation-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            margin-right: 12px;
        }

        .allocation-name {
            flex: 1;
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #2d3748;
        }

        .allocation-percent {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 20px;
            }

            .portfolio-value {
                font-size: 24px;
            }

            .ai-chat-panel {
                width: calc(100vw - 40px);
                right: 20px;
            }

            .btn {
                padding: 10px 18px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="logo">Portfolio Steward</div>
            </div>
            <div style="flex: 1; text-align: center;">
                <div class="portfolio-value" id="total-value">$0.00</div>
                <div class="portfolio-change positive" id="portfolio-change">+$0.00 (0%)</div>
            </div>
            <div class="header-right">
                <button class="btn btn-secondary" id="btn-import">Import</button>
                <button class="btn btn-primary" id="btn-add-asset">+ Add Asset</button>
                <button class="btn-icon" id="btn-settings">‚öôÔ∏è</button>
            </div>
        </div>

        <!-- Alert -->
        <div class="alert alert-info" id="ai-alert" style="display: none;">
            <span class="alert-icon">üí°</span>
            <div>
                <strong>AI Insight:</strong> <span id="ai-insight-text"></span>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid">
            <!-- Portfolio Overview -->
            <div class="card" style="grid-column: span 2;">
                <div class="card-header">
                    <h2 class="card-title">Portfolio Performance</h2>
                    <div class="tabs" id="chart-tabs">
                        <div class="tab active" data-period="1D">1D</div>
                        <div class="tab" data-period="1W">1W</div>
                        <div class="tab" data-period="1M">1M</div>
                        <div class="tab" data-period="3M">3M</div>
                        <div class="tab" data-period="1Y">1Y</div>
                        <div class="tab" data-period="ALL">ALL</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="performance-chart"></canvas>
                </div>
            </div>

            <!-- Asset Allocation -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Asset Allocation</h2>
                    <span class="card-action" id="view-allocation">View 3D</span>
                </div>
                <div class="chart-container" style="height: 250px;">
                    <canvas id="allocation-chart"></canvas>
                </div>
                <div id="allocation-list" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="card">
            <h2 class="card-title" style="margin-bottom: 20px;">Portfolio Statistics</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="stat-total-gain">$0</div>
                    <div class="stat-label">Total Gain</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-daily-change">$0</div>
                    <div class="stat-label">Daily Change</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-best-performer">-</div>
                    <div class="stat-label">Best Performer</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-worst-performer">-</div>
                    <div class="stat-label">Worst Performer</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-diversity">0</div>
                    <div class="stat-label">Diversity Score</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-risk-level">Low</div>
                    <div class="stat-label">Risk Level</div>
                </div>
            </div>
        </div>

        <!-- Holdings & Transactions -->
        <div class="grid grid-3">
            <!-- Holdings -->
            <div class="card" style="grid-column: span 2;">
                <div class="card-header">
                    <h2 class="card-title">Holdings</h2>
                    <span class="card-action" id="refresh-holdings">‚Üª Refresh</span>
                </div>
                <div id="holdings-list"></div>
            </div>

            <!-- Recent Transactions -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Recent Transactions</h2>
                    <span class="card-action" id="view-all-transactions">View All</span>
                </div>
                <div class="transaction-list" id="transaction-list"></div>
            </div>
        </div>

        <!-- 3D Visualization Modal -->
        <div class="modal" id="viz-modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">3D Portfolio Visualization</div>
                <div class="modal-body">
                    <div class="viz-container">
                        <canvas id="viz-canvas"></canvas>
                        <div class="viz-overlay">
                            <div class="viz-overlay-title">Hover assets for details</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="close-viz">Close</button>
                </div>
            </div>
        </div>

        <!-- Add Asset Modal -->
        <div class="modal" id="add-asset-modal">
            <div class="modal-content">
                <div class="modal-header">Add New Asset</div>
                <div class="modal-body">
                    <form id="add-asset-form">
                        <div class="form-group">
                            <label class="form-label">Asset Type</label>
                            <select class="form-select" id="asset-type" required>
                                <option value="">Select type...</option>
                                <option value="stock">Stock</option>
                                <option value="crypto">Cryptocurrency</option>
                                <option value="etf">ETF</option>
                                <option value="bond">Bond</option>
                                <option value="real-estate">Real Estate</option>
                                <option value="commodity">Commodity</option>
                                <option value="cash">Cash</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Symbol/Name</label>
                                <input type="text" class="form-input" id="asset-symbol" placeholder="BTC, AAPL, etc." required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-input" id="asset-name" placeholder="Bitcoin, Apple Inc." required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Quantity</label>
                                <input type="number" class="form-input" id="asset-quantity" placeholder="0.00" step="0.00000001" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Purchase Price</label>
                                <input type="number" class="form-input" id="asset-purchase-price" placeholder="0.00" step="0.01" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Current Price</label>
                            <input type="number" class="form-input" id="asset-current-price" placeholder="0.00" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Purchase Date</label>
                            <input type="date" class="form-input" id="asset-purchase-date" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancel-add-asset">Cancel</button>
                    <button class="btn btn-primary" id="confirm-add-asset">Add Asset</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Assistant -->
    <div class="ai-assistant" id="ai-assistant">ü§ñ</div>
    <div class="ai-chat-panel" id="ai-chat-panel">
        <div class="ai-chat-header">AI Portfolio Assistant</div>
        <div class="ai-chat-messages" id="ai-chat-messages">
            <div class="ai-message assistant">
                Hi! I'm your AI Portfolio Steward. I can help you analyze your portfolio, suggest rebalancing strategies, identify risks, and answer questions. What would you like to know?
            </div>
        </div>
        <div class="ai-chat-input">
            <input type="text" id="ai-input" placeholder="Ask me anything...">
            <button class="btn btn-primary" id="ai-send" style="padding: 10px 20px;">Send</button>
        </div>
    </div>

    <script>
        // Application State
        const AppState = {
            portfolio: {
                assets: [],
                transactions: [],
                totalValue: 0,
                totalCost: 0,
                totalGain: 0,
                dailyChange: 0
            },
            charts: {
                performance: null,
                allocation: null
            },
            viz: {
                scene: null,
                camera: null,
                renderer: null,
                objects: [],
                animationId: null
            },
            ai: {
                enabled: true,
                chatHistory: []
            },
            settings: {
                currency: 'USD',
                refreshInterval: 60000,
                riskTolerance: 'moderate'
            }
        };

        // AI Assistant Manager
        class AIAssistant {
            constructor() {
                this.patterns = this.loadPatterns();
                this.insights = [];
            }

            analyzePortfolio(portfolio) {
                const insights = [];

                // Diversification analysis
                const assetTypes = new Set(portfolio.assets.map(a => a.type));
                if (assetTypes.size < 3) {
                    insights.push({
                        type: 'warning',
                        message: `Your portfolio has low diversification (${assetTypes.size} asset types). Consider adding more variety to reduce risk.`
                    });
                }

                // Concentration risk
                const totalValue = portfolio.totalValue;
                portfolio.assets.forEach(asset => {
                    const percentage = (asset.currentValue / totalValue) * 100;
                    if (percentage > 40) {
                        insights.push({
                            type: 'warning',
                            message: `${asset.name} represents ${percentage.toFixed(1)}% of your portfolio. High concentration increases risk.`
                        });
                    }
                });

                // Performance analysis
                const topPerformer = this.findTopPerformer(portfolio.assets);
                if (topPerformer && topPerformer.gainPercent > 50) {
                    insights.push({
                        type: 'success',
                        message: `${topPerformer.name} is up ${topPerformer.gainPercent.toFixed(1)}%! Consider taking profits.`
                    });
                }

                const worstPerformer = this.findWorstPerformer(portfolio.assets);
                if (worstPerformer && worstPerformer.gainPercent < -20) {
                    insights.push({
                        type: 'warning',
                        message: `${worstPerformer.name} is down ${Math.abs(worstPerformer.gainPercent).toFixed(1)}%. Review if it still fits your strategy.`
                    });
                }

                // Rebalancing suggestion
                if (this.needsRebalancing(portfolio.assets)) {
                    insights.push({
                        type: 'info',
                        message: 'Your portfolio has drifted from optimal allocation. Consider rebalancing.'
                    });
                }

                return insights;
            }

            findTopPerformer(assets) {
                if (assets.length === 0) return null;
                return assets.reduce((top, asset) =>
                    asset.gainPercent > (top?.gainPercent || -Infinity) ? asset : top
                , null);
            }

            findWorstPerformer(assets) {
                if (assets.length === 0) return null;
                return assets.reduce((worst, asset) =>
                    asset.gainPercent < (worst?.gainPercent || Infinity) ? asset : worst
                , null);
            }

            needsRebalancing(assets) {
                // Simple rebalancing logic: check if any asset deviates >15% from ideal
                const idealPercent = 100 / assets.length;
                const totalValue = assets.reduce((sum, a) => sum + a.currentValue, 0);

                return assets.some(asset => {
                    const currentPercent = (asset.currentValue / totalValue) * 100;
                    return Math.abs(currentPercent - idealPercent) > 15;
                });
            }

            handleQuery(query, portfolio) {
                const lowerQuery = query.toLowerCase();

                // Portfolio summary
                if (lowerQuery.includes('summary') || lowerQuery.includes('overview')) {
                    return this.generateSummary(portfolio);
                }

                // Risk analysis
                if (lowerQuery.includes('risk')) {
                    return this.analyzeRisk(portfolio);
                }

                // Diversification
                if (lowerQuery.includes('divers') || lowerQuery.includes('balanced')) {
                    return this.analyzeDiversification(portfolio);
                }

                // Best/worst performers
                if (lowerQuery.includes('best') || lowerQuery.includes('top')) {
                    const top = this.findTopPerformer(portfolio.assets);
                    return top ? `Your best performer is ${top.name} with a gain of ${top.gainPercent.toFixed(2)}% (+$${top.gain.toFixed(2)}).` : 'No performance data available.';
                }

                if (lowerQuery.includes('worst') || lowerQuery.includes('losing')) {
                    const worst = this.findWorstPerformer(portfolio.assets);
                    return worst ? `Your worst performer is ${worst.name} with a loss of ${Math.abs(worst.gainPercent).toFixed(2)}% (-$${Math.abs(worst.gain).toFixed(2)}).` : 'No performance data available.';
                }

                // Rebalancing
                if (lowerQuery.includes('rebalanc')) {
                    return this.suggestRebalancing(portfolio);
                }

                // Tax optimization
                if (lowerQuery.includes('tax')) {
                    return this.analyzeTaxOptimization(portfolio);
                }

                // Generic response
                return "I can help you with: portfolio summary, risk analysis, diversification review, performance insights, rebalancing suggestions, and tax optimization. What would you like to know?";
            }

            generateSummary(portfolio) {
                const totalAssets = portfolio.assets.length;
                const totalValue = portfolio.totalValue;
                const totalGain = portfolio.totalGain;
                const gainPercent = (totalGain / portfolio.totalCost) * 100;

                return `Portfolio Summary:\n\n` +
                    `Total Assets: ${totalAssets}\n` +
                    `Total Value: $${totalValue.toFixed(2)}\n` +
                    `Total Gain: $${totalGain.toFixed(2)} (${gainPercent.toFixed(2)}%)\n` +
                    `Daily Change: $${portfolio.dailyChange.toFixed(2)}\n\n` +
                    `Your portfolio is ${gainPercent > 0 ? 'performing well' : 'experiencing losses'}. ${this.getMarketSentiment(gainPercent)}`;
            }

            analyzeRisk(portfolio) {
                const assetTypes = new Set(portfolio.assets.map(a => a.type));
                const diversityScore = assetTypes.size;

                let riskLevel = 'Low';
                if (diversityScore < 3) riskLevel = 'High';
                else if (diversityScore < 5) riskLevel = 'Medium';

                return `Risk Analysis:\n\n` +
                    `Diversity Score: ${diversityScore}/8\n` +
                    `Risk Level: ${riskLevel}\n\n` +
                    `Recommendation: ${this.getRiskRecommendation(diversityScore, portfolio)}`;
            }

            analyzeDiversification(portfolio) {
                const assetTypes = {};
                const totalValue = portfolio.totalValue;

                portfolio.assets.forEach(asset => {
                    if (!assetTypes[asset.type]) {
                        assetTypes[asset.type] = 0;
                    }
                    assetTypes[asset.type] += asset.currentValue;
                });

                let analysis = "Diversification Breakdown:\n\n";
                Object.keys(assetTypes).forEach(type => {
                    const percent = (assetTypes[type] / totalValue) * 100;
                    analysis += `${type.toUpperCase()}: ${percent.toFixed(1)}%\n`;
                });

                analysis += `\n${this.getDiversificationAdvice(assetTypes, totalValue)}`;
                return analysis;
            }

            suggestRebalancing(portfolio) {
                const totalValue = portfolio.totalValue;
                const idealPercent = 100 / portfolio.assets.length;

                let suggestions = "Rebalancing Suggestions:\n\n";
                let needsRebalancing = false;

                portfolio.assets.forEach(asset => {
                    const currentPercent = (asset.currentValue / totalValue) * 100;
                    const deviation = currentPercent - idealPercent;

                    if (Math.abs(deviation) > 10) {
                        needsRebalancing = true;
                        if (deviation > 0) {
                            suggestions += `SELL ${asset.symbol}: Currently ${currentPercent.toFixed(1)}%, target ${idealPercent.toFixed(1)}%\n`;
                        } else {
                            suggestions += `BUY ${asset.symbol}: Currently ${currentPercent.toFixed(1)}%, target ${idealPercent.toFixed(1)}%\n`;
                        }
                    }
                });

                if (!needsRebalancing) {
                    return "Your portfolio is well-balanced! No rebalancing needed at this time.";
                }

                return suggestions;
            }

            analyzeTaxOptimization(portfolio) {
                const longTerm = [];
                const shortTerm = [];
                const today = new Date();

                portfolio.assets.forEach(asset => {
                    const purchaseDate = new Date(asset.purchaseDate);
                    const daysHeld = Math.floor((today - purchaseDate) / (1000 * 60 * 60 * 24));

                    if (daysHeld >= 365) {
                        longTerm.push(asset);
                    } else {
                        shortTerm.push(asset);
                    }
                });

                return `Tax Optimization Analysis:\n\n` +
                    `Long-term holdings (>1 year): ${longTerm.length}\n` +
                    `Short-term holdings (<1 year): ${shortTerm.length}\n\n` +
                    `Tip: Long-term capital gains are taxed at a lower rate. Consider holding assets for at least one year before selling.`;
            }

            getMarketSentiment(gainPercent) {
                if (gainPercent > 20) return "Excellent growth! Consider taking some profits.";
                if (gainPercent > 10) return "Strong performance! Keep monitoring.";
                if (gainPercent > 0) return "Positive returns. Stay the course.";
                if (gainPercent > -10) return "Minor losses. Don't panic sell.";
                return "Significant losses. Review your strategy.";
            }

            getRiskRecommendation(diversityScore, portfolio) {
                if (diversityScore < 3) {
                    return "Your portfolio needs more diversification. Add different asset types like bonds, real estate, or commodities.";
                }
                if (diversityScore < 5) {
                    return "Moderate diversification. Consider adding 1-2 more asset types for better risk management.";
                }
                return "Good diversification! Your portfolio is spread across multiple asset types.";
            }

            getDiversificationAdvice(assetTypes, totalValue) {
                const typeCount = Object.keys(assetTypes).length;

                if (typeCount < 3) {
                    return "Low diversification. Add more asset types to reduce risk.";
                }

                // Check for over-concentration
                for (const type in assetTypes) {
                    const percent = (assetTypes[type] / totalValue) * 100;
                    if (percent > 60) {
                        return `Over-concentrated in ${type.toUpperCase()} (${percent.toFixed(1)}%). Consider reducing this position.`;
                    }
                }

                return "Balanced diversification. Your portfolio is well-distributed.";
            }

            loadPatterns() {
                return {
                    greeting: /hello|hi|hey/i,
                    summary: /summary|overview|status/i,
                    risk: /risk|safe|dangerous/i,
                    diversification: /divers|balanced|spread/i,
                    performance: /perform|gain|loss|profit/i,
                    rebalance: /rebalanc|adjust|reallocate/i
                };
            }
        }

        // Portfolio Manager
        class PortfolioManager {
            constructor() {
                this.assets = this.loadAssets();
                this.transactions = this.loadTransactions();
            }

            addAsset(asset) {
                asset.id = this.generateId();
                asset.currentValue = asset.quantity * asset.currentPrice;
                asset.costBasis = asset.quantity * asset.purchasePrice;
                asset.gain = asset.currentValue - asset.costBasis;
                asset.gainPercent = (asset.gain / asset.costBasis) * 100;

                this.assets.push(asset);
                this.addTransaction({
                    type: 'buy',
                    assetId: asset.id,
                    symbol: asset.symbol,
                    name: asset.name,
                    quantity: asset.quantity,
                    price: asset.purchasePrice,
                    total: asset.costBasis,
                    date: asset.purchaseDate
                });

                this.saveAssets();
                this.saveTransactions();
                return asset;
            }

            removeAsset(assetId) {
                const index = this.assets.findIndex(a => a.id === assetId);
                if (index !== -1) {
                    const asset = this.assets[index];
                    this.addTransaction({
                        type: 'sell',
                        assetId: asset.id,
                        symbol: asset.symbol,
                        name: asset.name,
                        quantity: asset.quantity,
                        price: asset.currentPrice,
                        total: asset.currentValue,
                        date: new Date().toISOString().split('T')[0]
                    });

                    this.assets.splice(index, 1);
                    this.saveAssets();
                    this.saveTransactions();
                }
            }

            updateAssetPrice(assetId, newPrice) {
                const asset = this.assets.find(a => a.id === assetId);
                if (asset) {
                    asset.currentPrice = newPrice;
                    asset.currentValue = asset.quantity * newPrice;
                    asset.gain = asset.currentValue - asset.costBasis;
                    asset.gainPercent = (asset.gain / asset.costBasis) * 100;
                    this.saveAssets();
                }
            }

            addTransaction(transaction) {
                transaction.id = this.generateId();
                transaction.timestamp = new Date().toISOString();
                this.transactions.unshift(transaction);

                // Keep only last 100 transactions
                if (this.transactions.length > 100) {
                    this.transactions = this.transactions.slice(0, 100);
                }

                this.saveTransactions();
            }

            calculatePortfolioStats() {
                const totalValue = this.assets.reduce((sum, a) => sum + a.currentValue, 0);
                const totalCost = this.assets.reduce((sum, a) => sum + a.costBasis, 0);
                const totalGain = totalValue - totalCost;

                // Simulate daily change (would come from API in production)
                const dailyChange = totalValue * (Math.random() * 0.04 - 0.02);

                return {
                    assets: this.assets,
                    transactions: this.transactions,
                    totalValue,
                    totalCost,
                    totalGain,
                    dailyChange
                };
            }

            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            saveAssets() {
                localStorage.setItem('portfolioAssets', JSON.stringify(this.assets));
            }

            loadAssets() {
                try {
                    const saved = localStorage.getItem('portfolioAssets');
                    return saved ? JSON.parse(saved) : this.getDefaultAssets();
                } catch {
                    return this.getDefaultAssets();
                }
            }

            saveTransactions() {
                localStorage.setItem('portfolioTransactions', JSON.stringify(this.transactions));
            }

            loadTransactions() {
                try {
                    const saved = localStorage.getItem('portfolioTransactions');
                    return saved ? JSON.parse(saved) : [];
                } catch {
                    return [];
                }
            }

            getDefaultAssets() {
                // Sample portfolio
                return [
                    {
                        id: '1',
                        type: 'stock',
                        symbol: 'AAPL',
                        name: 'Apple Inc.',
                        quantity: 10,
                        purchasePrice: 150,
                        currentPrice: 175,
                        purchaseDate: '2024-01-15',
                        currentValue: 1750,
                        costBasis: 1500,
                        gain: 250,
                        gainPercent: 16.67
                    },
                    {
                        id: '2',
                        type: 'crypto',
                        symbol: 'BTC',
                        name: 'Bitcoin',
                        quantity: 0.5,
                        purchasePrice: 45000,
                        currentPrice: 52000,
                        purchaseDate: '2024-03-01',
                        currentValue: 26000,
                        costBasis: 22500,
                        gain: 3500,
                        gainPercent: 15.56
                    },
                    {
                        id: '3',
                        type: 'etf',
                        symbol: 'SPY',
                        name: 'S&P 500 ETF',
                        quantity: 20,
                        purchasePrice: 420,
                        currentPrice: 445,
                        purchaseDate: '2024-02-10',
                        currentValue: 8900,
                        costBasis: 8400,
                        gain: 500,
                        gainPercent: 5.95
                    }
                ];
            }
        }

        // Initialize
        const portfolioManager = new PortfolioManager();
        const aiAssistant = new AIAssistant();
        let performanceChart, allocationChart;

        function init() {
            updatePortfolio();
            initCharts();
            initEventListeners();
            runAIAnalysis();

            // Auto-refresh every minute
            setInterval(simulatePriceUpdates, AppState.settings.refreshInterval);
        }

        function updatePortfolio() {
            AppState.portfolio = portfolioManager.calculatePortfolioStats();
            updateUI();
        }

        function updateUI() {
            const p = AppState.portfolio;

            // Header
            document.getElementById('total-value').textContent = formatCurrency(p.totalValue);

            const changeEl = document.getElementById('portfolio-change');
            const changePercent = (p.totalGain / p.totalCost) * 100;
            changeEl.textContent = `${p.totalGain >= 0 ? '+' : ''}${formatCurrency(p.totalGain)} (${changePercent.toFixed(2)}%)`;
            changeEl.className = `portfolio-change ${p.totalGain >= 0 ? 'positive' : 'negative'}`;

            // Stats
            document.getElementById('stat-total-gain').textContent = formatCurrency(p.totalGain);
            document.getElementById('stat-daily-change').textContent = formatCurrency(p.dailyChange);

            const topPerformer = aiAssistant.findTopPerformer(p.assets);
            document.getElementById('stat-best-performer').textContent = topPerformer ? topPerformer.symbol : '-';

            const worstPerformer = aiAssistant.findWorstPerformer(p.assets);
            document.getElementById('stat-worst-performer').textContent = worstPerformer ? worstPerformer.symbol : '-';

            const assetTypes = new Set(p.assets.map(a => a.type));
            document.getElementById('stat-diversity').textContent = assetTypes.size;

            const riskLevel = assetTypes.size < 3 ? 'High' : assetTypes.size < 5 ? 'Medium' : 'Low';
            document.getElementById('stat-risk-level').textContent = riskLevel;

            // Holdings
            renderHoldings();

            // Transactions
            renderTransactions();

            // Charts
            updateCharts();
        }

        function renderHoldings() {
            const container = document.getElementById('holdings-list');
            container.innerHTML = '';

            AppState.portfolio.assets.forEach(asset => {
                const card = document.createElement('div');
                card.className = 'asset-card';
                card.onclick = () => showAssetDetails(asset);

                const color = getAssetColor(asset.type);

                card.innerHTML = `
                    <div class="asset-icon" style="background: ${color};">
                        ${asset.symbol.substring(0, 2).toUpperCase()}
                    </div>
                    <div class="asset-info">
                        <div class="asset-name">${asset.name}</div>
                        <div class="asset-symbol">${asset.quantity} √ó ${formatCurrency(asset.currentPrice)}</div>
                    </div>
                    <div class="asset-value">
                        <div class="asset-price">${formatCurrency(asset.currentValue)}</div>
                        <div class="asset-change ${asset.gain >= 0 ? 'positive' : 'negative'}">
                            ${asset.gain >= 0 ? '+' : ''}${formatCurrency(asset.gain)} (${asset.gainPercent.toFixed(2)}%)
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        function renderTransactions() {
            const container = document.getElementById('transaction-list');
            container.innerHTML = '';

            const recentTransactions = AppState.portfolio.transactions.slice(0, 5);

            recentTransactions.forEach(tx => {
                const item = document.createElement('div');
                item.className = 'transaction-item';

                item.innerHTML = `
                    <div class="transaction-info">
                        <div class="transaction-type">${tx.name}</div>
                        <div class="transaction-date">${formatDate(tx.date)}</div>
                    </div>
                    <div class="transaction-amount">
                        <div class="transaction-value">${formatCurrency(tx.total)}</div>
                        <div class="transaction-badge ${tx.type}">${tx.type.toUpperCase()}</div>
                    </div>
                `;

                container.appendChild(item);
            });
        }

        function initCharts() {
            // Performance Chart
            const perfCtx = document.getElementById('performance-chart').getContext('2d');
            performanceChart = new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: generateTimeLabels('1D'),
                    datasets: [{
                        label: 'Portfolio Value',
                        data: generatePerformanceData('1D'),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: (context) => formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: (value) => '$' + value.toLocaleString()
                            }
                        }
                    }
                }
            });

            // Allocation Chart
            const allocCtx = document.getElementById('allocation-chart').getContext('2d');
            allocationChart = new Chart(allocCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: []
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            updateCharts();
        }

        function updateCharts() {
            // Update allocation chart
            const assetTypes = {};
            const totalValue = AppState.portfolio.totalValue;

            AppState.portfolio.assets.forEach(asset => {
                if (!assetTypes[asset.type]) {
                    assetTypes[asset.type] = 0;
                }
                assetTypes[asset.type] += asset.currentValue;
            });

            const labels = Object.keys(assetTypes);
            const data = Object.values(assetTypes);
            const colors = labels.map(type => getAssetColor(type));

            allocationChart.data.labels = labels.map(l => l.toUpperCase());
            allocationChart.data.datasets[0].data = data;
            allocationChart.data.datasets[0].backgroundColor = colors;
            allocationChart.update();

            // Update allocation list
            const listContainer = document.getElementById('allocation-list');
            listContainer.innerHTML = '';

            labels.forEach((type, index) => {
                const percent = (data[index] / totalValue) * 100;
                const item = document.createElement('div');
                item.className = 'allocation-item';
                item.innerHTML = `
                    <div class="allocation-name">
                        <div class="allocation-color" style="background: ${colors[index]};"></div>
                        ${type.toUpperCase()}
                    </div>
                    <div class="allocation-percent">${percent.toFixed(1)}%</div>
                `;
                listContainer.appendChild(item);
            });
        }

        function generateTimeLabels(period) {
            const labels = [];
            const now = new Date();

            if (period === '1D') {
                for (let i = 24; i >= 0; i--) {
                    const date = new Date(now - i * 3600000);
                    labels.push(date.getHours() + ':00');
                }
            } else if (period === '1W') {
                for (let i = 7; i >= 0; i--) {
                    const date = new Date(now - i * 86400000);
                    labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                }
            } else if (period === '1M') {
                for (let i = 30; i >= 0; i--) {
                    const date = new Date(now - i * 86400000);
                    labels.push(date.getDate());
                }
            }

            return labels;
        }

        function generatePerformanceData(period) {
            const baseValue = AppState.portfolio.totalValue;
            const data = [];
            let numPoints = 25;

            if (period === '1W') numPoints = 8;
            if (period === '1M') numPoints = 31;

            let currentValue = baseValue * 0.9;

            for (let i = 0; i < numPoints; i++) {
                const change = (Math.random() - 0.48) * baseValue * 0.02;
                currentValue += change;
                data.push(Math.round(currentValue));
            }

            // Ensure last value matches current
            data[data.length - 1] = Math.round(baseValue);

            return data;
        }

        function initEventListeners() {
            // Add Asset
            document.getElementById('btn-add-asset').addEventListener('click', () => {
                document.getElementById('add-asset-modal').classList.add('active');
                document.getElementById('asset-purchase-date').valueAsDate = new Date();
            });

            document.getElementById('cancel-add-asset').addEventListener('click', () => {
                document.getElementById('add-asset-modal').classList.remove('active');
            });

            document.getElementById('confirm-add-asset').addEventListener('click', () => {
                const asset = {
                    type: document.getElementById('asset-type').value,
                    symbol: document.getElementById('asset-symbol').value.toUpperCase(),
                    name: document.getElementById('asset-name').value,
                    quantity: parseFloat(document.getElementById('asset-quantity').value),
                    purchasePrice: parseFloat(document.getElementById('asset-purchase-price').value),
                    currentPrice: parseFloat(document.getElementById('asset-current-price').value),
                    purchaseDate: document.getElementById('asset-purchase-date').value
                };

                portfolioManager.addAsset(asset);
                updatePortfolio();
                runAIAnalysis();

                document.getElementById('add-asset-modal').classList.remove('active');
                document.getElementById('add-asset-form').reset();
            });

            // Chart Period Tabs
            document.querySelectorAll('#chart-tabs .tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('#chart-tabs .tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    const period = tab.dataset.period;
                    performanceChart.data.labels = generateTimeLabels(period);
                    performanceChart.data.datasets[0].data = generatePerformanceData(period);
                    performanceChart.update();
                });
            });

            // 3D Visualization
            document.getElementById('view-allocation').addEventListener('click', () => {
                document.getElementById('viz-modal').classList.add('active');
                init3DVisualization();
            });

            document.getElementById('close-viz').addEventListener('click', () => {
                document.getElementById('viz-modal').classList.remove('active');
                if (AppState.viz.animationId) {
                    cancelAnimationFrame(AppState.viz.animationId);
                }
            });

            // AI Assistant
            document.getElementById('ai-assistant').addEventListener('click', () => {
                document.getElementById('ai-chat-panel').classList.toggle('active');
            });

            document.getElementById('ai-send').addEventListener('click', sendAIMessage);
            document.getElementById('ai-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendAIMessage();
            });

            // Refresh
            document.getElementById('refresh-holdings').addEventListener('click', () => {
                simulatePriceUpdates();
            });
        }

        function init3DVisualization() {
            const canvas = document.getElementById('viz-canvas');
            const width = canvas.clientWidth;
            const height = canvas.clientHeight;

            // Scene
            AppState.viz.scene = new THREE.Scene();
            AppState.viz.scene.background = new THREE.Color(0xf7fafc);

            // Camera
            AppState.viz.camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            AppState.viz.camera.position.z = 50;

            // Renderer
            AppState.viz.renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            AppState.viz.renderer.setSize(width, height);

            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            AppState.viz.scene.add(ambientLight);

            const pointLight = new THREE.PointLight(0xffffff, 0.8);
            pointLight.position.set(20, 20, 20);
            AppState.viz.scene.add(pointLight);

            // Create asset spheres
            AppState.viz.objects = [];
            const totalValue = AppState.portfolio.totalValue;
            let angle = 0;
            const radius = 30;

            AppState.portfolio.assets.forEach((asset, index) => {
                const size = Math.max(3, (asset.currentValue / totalValue) * 30);
                const geometry = new THREE.SphereGeometry(size, 32, 32);
                const material = new THREE.MeshPhongMaterial({
                    color: getAssetColor(asset.type),
                    emissive: getAssetColor(asset.type),
                    emissiveIntensity: 0.3
                });
                const sphere = new THREE.Mesh(geometry, material);

                const x = Math.cos(angle) * radius;
                const y = Math.sin(angle) * radius;
                sphere.position.set(x, y, 0);

                sphere.userData = asset;

                AppState.viz.scene.add(sphere);
                AppState.viz.objects.push(sphere);

                angle += (Math.PI * 2) / AppState.portfolio.assets.length;
            });

            animate3D();
        }

        function animate3D() {
            AppState.viz.animationId = requestAnimationFrame(animate3D);

            AppState.viz.objects.forEach((obj, index) => {
                obj.rotation.x += 0.01;
                obj.rotation.y += 0.01;

                // Orbit around center
                const angle = Date.now() * 0.0003 + (index * Math.PI * 2) / AppState.viz.objects.length;
                const radius = 30;
                obj.position.x = Math.cos(angle) * radius;
                obj.position.y = Math.sin(angle) * radius;
            });

            AppState.viz.renderer.render(AppState.viz.scene, AppState.viz.camera);
        }

        function sendAIMessage() {
            const input = document.getElementById('ai-input');
            const message = input.value.trim();
            if (!message) return;

            // Add user message
            addAIMessage(message, 'user');

            // Get AI response
            const response = aiAssistant.handleQuery(message, AppState.portfolio);

            // Add AI response
            setTimeout(() => {
                addAIMessage(response, 'assistant');
            }, 500);

            input.value = '';
        }

        function addAIMessage(text, sender) {
            const container = document.getElementById('ai-chat-messages');
            const message = document.createElement('div');
            message.className = `ai-message ${sender}`;
            message.textContent = text;
            container.appendChild(message);
            container.scrollTop = container.scrollHeight;
        }

        function runAIAnalysis() {
            const insights = aiAssistant.analyzePortfolio(AppState.portfolio);

            if (insights.length > 0) {
                const alert = document.getElementById('ai-alert');
                const text = document.getElementById('ai-insight-text');

                // Show random insight
                const insight = insights[Math.floor(Math.random() * insights.length)];
                text.textContent = insight.message;
                alert.style.display = 'flex';
                alert.className = `alert alert-${insight.type}`;

                // Hide after 10 seconds
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 10000);
            }
        }

        function simulatePriceUpdates() {
            // Simulate price changes
            AppState.portfolio.assets.forEach(asset => {
                const change = (Math.random() - 0.5) * asset.currentPrice * 0.05;
                const newPrice = Math.max(0.01, asset.currentPrice + change);
                portfolioManager.updateAssetPrice(asset.id, newPrice);
            });

            updatePortfolio();
        }

        function showAssetDetails(asset) {
            alert(`${asset.name} (${asset.symbol})\n\n` +
                `Quantity: ${asset.quantity}\n` +
                `Purchase Price: ${formatCurrency(asset.purchasePrice)}\n` +
                `Current Price: ${formatCurrency(asset.currentPrice)}\n` +
                `Current Value: ${formatCurrency(asset.currentValue)}\n` +
                `Gain/Loss: ${formatCurrency(asset.gain)} (${asset.gainPercent.toFixed(2)}%)\n` +
                `Purchase Date: ${asset.purchaseDate}`
            );
        }

        function getAssetColor(type) {
            const colors = {
                stock: '#667eea',
                crypto: '#f6ad55',
                etf: '#48bb78',
                bond: '#4299e1',
                'real-estate': '#ed8936',
                commodity: '#9f7aea',
                cash: '#38b2ac',
                other: '#718096'
            };
            return colors[type] || colors.other;
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>
