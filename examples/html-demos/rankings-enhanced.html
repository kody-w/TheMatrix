<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Battle Assistant - Rankings Viewer Enhanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #aaa;
            font-size: 1.1em;
        }

        /* Controls Panel */
        .controls-panel {
            background: #16213e;
            border: 1px solid #0f3460;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-weight: 600;
            font-size: 0.9em;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-group select,
        .control-group input {
            padding: 10px 15px;
            background: #0f3460;
            border: 1px solid #0f3460;
            border-radius: 6px;
            color: #fff;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-group select:hover,
        .control-group input:hover {
            border-color: #667eea;
            background: #1a2d4d;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        /* Button Styles */
        .button-group {
            display: flex;
            gap: 10px;
            grid-column: span 1;
        }

        button {
            padding: 10px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 6px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            flex: 1;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: #0f3460;
            border: 1px solid #667eea;
            color: #667eea;
        }

        button.secondary:hover {
            background: #1a2d4d;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        /* Rankings Table */
        .rankings-container {
            background: #16213e;
            border: 1px solid #0f3460;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .rankings-table {
            width: 100%;
            border-collapse: collapse;
            background: #16213e;
        }

        .rankings-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .rankings-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            user-select: none;
            border-bottom: 2px solid #0f3460;
        }

        .rankings-table th:hover {
            background: rgba(102, 126, 234, 0.8);
        }

        .rankings-table th.active {
            color: #fff;
            position: relative;
        }

        .rankings-table th.active::after {
            content: ' ↑';
            font-size: 0.8em;
        }

        .rankings-table th.active.desc::after {
            content: ' ↓';
        }

        .rankings-table tbody tr {
            border-bottom: 1px solid #0f3460;
            transition: all 0.2s;
        }

        .rankings-table tbody tr:hover {
            background: #1a2d4d;
            box-shadow: inset 0 0 10px rgba(102, 126, 234, 0.1);
        }

        .rankings-table td {
            padding: 15px;
            font-size: 0.95em;
        }

        .rank-cell {
            font-weight: 600;
            color: #667eea;
            font-size: 1.1em;
            width: 50px;
        }

        .pokemon-cell {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            position: relative;
        }

        .pokemon-sprite {
            width: 40px;
            height: 40px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .pokemon-sprite img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .pokemon-info h3 {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .pokemon-info .types {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .type-badge {
            display: inline-block;
            padding: 2px 8px;
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.5);
            border-radius: 4px;
            font-size: 0.75em;
            text-transform: capitalize;
        }

        .type-badge.fire { background: rgba(240, 128, 48, 0.2); border-color: rgba(240, 128, 48, 0.5); }
        .type-badge.water { background: rgba(104, 144, 240, 0.2); border-color: rgba(104, 144, 240, 0.5); }
        .type-badge.grass { background: rgba(120, 200, 80, 0.2); border-color: rgba(120, 200, 80, 0.5); }
        .type-badge.electric { background: rgba(248, 208, 48, 0.2); border-color: rgba(248, 208, 48, 0.5); }
        .type-badge.psychic { background: rgba(248, 88, 136, 0.2); border-color: rgba(248, 88, 136, 0.5); }
        .type-badge.ice { background: rgba(152, 216, 216, 0.2); border-color: rgba(152, 216, 216, 0.5); }
        .type-badge.dragon { background: rgba(120, 80, 200, 0.2); border-color: rgba(120, 80, 200, 0.5); }
        .type-badge.dark { background: rgba(112, 88, 72, 0.2); border-color: rgba(112, 88, 72, 0.5); }
        .type-badge.steel { background: rgba(184, 184, 208, 0.2); border-color: rgba(184, 184, 208, 0.5); }
        .type-badge.fairy { background: rgba(238, 153, 172, 0.2); border-color: rgba(238, 153, 172, 0.5); }
        .type-badge.flying { background: rgba(168, 144, 240, 0.2); border-color: rgba(168, 144, 240, 0.5); }
        .type-badge.poison { background: rgba(160, 64, 160, 0.2); border-color: rgba(160, 64, 160, 0.5); }
        .type-badge.ground { background: rgba(224, 192, 104, 0.2); border-color: rgba(224, 192, 104, 0.5); }
        .type-badge.rock { background: rgba(184, 160, 56, 0.2); border-color: rgba(184, 160, 56, 0.5); }
        .type-badge.bug { background: rgba(168, 184, 32, 0.2); border-color: rgba(168, 184, 32, 0.5); }
        .type-badge.ghost { background: rgba(112, 88, 152, 0.2); border-color: rgba(112, 88, 152, 0.5); }
        .type-badge.normal { background: rgba(168, 168, 120, 0.2); border-color: rgba(168, 168, 120, 0.5); }
        .type-badge.fighting { background: rgba(192, 48, 40, 0.2); border-color: rgba(192, 48, 40, 0.5); }

        .score-cell {
            font-weight: 600;
            color: #4ecca3;
        }

        .stat-bar {
            display: inline-block;
            height: 20px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            position: relative;
            min-width: 80px;
            margin-right: 8px;
        }

        .stat-bar-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75em;
            font-weight: 600;
            color: #fff;
            white-space: nowrap;
        }

        .role-badge {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(78, 204, 163, 0.2);
            border: 1px solid rgba(78, 204, 163, 0.5);
            border-radius: 4px;
            font-size: 0.8em;
            color: #4ecca3;
            text-transform: capitalize;
            font-weight: 600;
        }

        /* Pokemon Preview Popup */
        .preview-popup {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: #0f3460;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            z-index: 1000;
            min-width: 300px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: none;
            flex-direction: column;
            gap: 10px;
        }

        .pokemon-cell:hover .preview-popup {
            display: flex;
        }

        .preview-header {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .preview-sprite {
            width: 80px;
            height: 80px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #667eea;
        }

        .preview-sprite img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .preview-info h3 {
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .preview-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            font-size: 0.85em;
        }

        .stat-item {
            background: rgba(102, 126, 234, 0.1);
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-item label {
            display: block;
            color: #aaa;
            font-size: 0.8em;
            margin-bottom: 3px;
        }

        .stat-item .value {
            font-weight: 600;
            color: #667eea;
            font-size: 1.1em;
        }

        .move-suggestions {
            border-top: 1px solid #0f3460;
            padding-top: 10px;
        }

        .move-suggestions h4 {
            font-size: 0.9em;
            margin-bottom: 8px;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .moves-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 150px;
            overflow-y: auto;
        }

        .move-item {
            padding: 6px 10px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 4px;
            font-size: 0.85em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .move-name {
            font-weight: 600;
        }

        .move-type {
            font-size: 0.75em;
            color: #aaa;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 30px;
            align-items: center;
        }

        .pagination button {
            padding: 8px 12px;
            min-width: 40px;
        }

        .pagination span {
            color: #aaa;
            font-weight: 600;
        }

        /* Favorites Panel */
        .sidebar {
            position: fixed;
            right: -350px;
            top: 0;
            width: 350px;
            height: 100vh;
            background: #0f3460;
            border-left: 1px solid #0f3460;
            padding: 20px;
            overflow-y: auto;
            transition: right 0.3s ease;
            z-index: 100;
        }

        .sidebar.active {
            right: 0;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }

        .sidebar-header h2 {
            font-size: 1.3em;
        }

        .sidebar-close {
            background: none;
            border: none;
            color: #667eea;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            width: auto;
            min-width: auto;
        }

        .favorites-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .favorite-item {
            background: #16213e;
            border: 1px solid #0f3460;
            padding: 12px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .favorite-item:hover {
            border-color: #667eea;
            background: #1a2d4d;
        }

        .favorite-item-name {
            font-weight: 600;
        }

        .favorite-item-remove {
            background: none;
            border: none;
            color: #ff6b6b;
            cursor: pointer;
            font-weight: 600;
            padding: 5px 10px;
            min-width: auto;
            width: auto;
        }

        /* Status Messages */
        .status-message {
            text-align: center;
            padding: 30px;
            color: #aaa;
            font-size: 1.1em;
        }

        .error-message {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.5);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .success-message {
            background: rgba(78, 204, 163, 0.1);
            border: 1px solid rgba(78, 204, 163, 0.5);
            color: #4ecca3;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #aaa;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        @media (max-width: 1024px) {
            .controls-panel {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .controls-panel {
                grid-template-columns: 1fr;
                padding: 15px;
            }

            .rankings-table {
                font-size: 0.9em;
            }

            .rankings-table th,
            .rankings-table td {
                padding: 10px;
            }

            .pokemon-cell {
                gap: 8px;
            }

            .pokemon-sprite {
                width: 32px;
                height: 32px;
            }

            .sidebar {
                width: 100%;
                right: -100%;
            }

            .pokemon-info h3 {
                font-size: 0.95em;
            }

            .preview-popup {
                min-width: 250px;
                padding: 12px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.4em;
            }

            .rankings-table thead {
                font-size: 0.8em;
            }

            .rankings-table th,
            .rankings-table td {
                padding: 8px 5px;
            }

            .button-group {
                grid-column: span 1;
                flex-direction: column;
            }

            .preview-stats {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Rankings Viewer Enhanced</h1>
            <p>Explore the meta with advanced filtering and analysis</p>
        </div>

        <!-- Controls Panel -->
        <div class="controls-panel">
            <div class="control-group">
                <label>League</label>
                <select id="leagueSelect">
                    <option value="great">Great League (1500 CP)</option>
                    <option value="ultra">Ultra League (2500 CP)</option>
                    <option value="master">Master League (Unlimited)</option>
                    <option value="custom">Custom CP</option>
                </select>
            </div>

            <div class="control-group">
                <label>Custom CP</label>
                <input type="number" id="customCP" placeholder="Enter CP" min="0" max="10000">
            </div>

            <div class="control-group">
                <label>Meta</label>
                <select id="metaSelect">
                    <option value="">Loading metas...</option>
                </select>
            </div>

            <div class="control-group">
                <label>Type Filter</label>
                <select id="typeFilter">
                    <option value="">All Types</option>
                </select>
            </div>

            <div class="control-group">
                <label>Role Filter</label>
                <select id="roleFilter">
                    <option value="">All Roles</option>
                    <option value="attacker">Attacker</option>
                    <option value="bulky">Bulky</option>
                    <option value="switcher">Switcher</option>
                    <option value="charmer">Charmer</option>
                </select>
            </div>

            <div class="control-group">
                <label>Generation Filter</label>
                <select id="genFilter">
                    <option value="">All Generations</option>
                    <option value="1">Gen 1 (Kanto)</option>
                    <option value="2">Gen 2 (Johto)</option>
                    <option value="3">Gen 3 (Hoenn)</option>
                    <option value="4">Gen 4 (Sinnoh)</option>
                    <option value="5">Gen 5 (Unova)</option>
                    <option value="6">Gen 6 (Kalos)</option>
                    <option value="7">Gen 7 (Alola)</option>
                    <option value="8">Gen 8 (Galar)</option>
                    <option value="9">Gen 9 (Paldea)</option>
                </select>
            </div>

            <div class="button-group">
                <button id="favoritesBtn">❤ Favorites</button>
                <button id="exportBtn" class="secondary">⬇ Export CSV</button>
                <button id="resetBtn" class="secondary">↻ Reset</button>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusContainer"></div>

        <!-- Rankings Table -->
        <div class="rankings-container">
            <table class="rankings-table">
                <thead>
                    <tr>
                        <th onclick="sortTable('rank')">Rank</th>
                        <th onclick="sortTable('name')">Pokemon</th>
                        <th onclick="sortTable('score')">Score</th>
                        <th onclick="sortTable('consistency')">Consistency</th>
                        <th onclick="sortTable('tdo')">TDO</th>
                        <th onclick="sortTable('bulk')">Bulk</th>
                        <th>Role</th>
                        <th>Type</th>
                    </tr>
                </thead>
                <tbody id="rankingsBody">
                    <tr>
                        <td colspan="8" class="status-message">
                            <div class="loading"></div> Loading rankings...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="paginationContainer"></div>
    </div>

    <!-- Favorites Sidebar -->
    <div class="sidebar" id="favoritesSidebar">
        <div class="sidebar-header">
            <h2>Favorites</h2>
            <button class="sidebar-close" onclick="toggleFavorites()">✕</button>
        </div>
        <div id="favoritesList" class="favorites-list">
            <p style="color: #aaa; text-align: center;">No favorites yet</p>
        </div>
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #0f3460;">
            <button onclick="saveList()" style="width: 100%; margin-bottom: 10px;">💾 Save List</button>
            <button onclick="loadList()" class="secondary" style="width: 100%;">📂 Load List</button>
        </div>
    </div>

    <script>
        // ==================== DATA MANAGEMENT ====================

        let gamemaster = null;
        let rankings = [];
        let filteredRankings = [];
        let currentSort = { field: 'rank', direction: 'asc' };
        let currentPage = 1;
        const itemsPerPage = 50;
        const generations = {
            1: [1, 151], 2: [152, 251], 3: [252, 386], 4: [387, 493], 5: [494, 649],
            6: [650, 721], 7: [722, 809], 8: [810, 898], 9: [899, 1025]
        };

        // ==================== INITIALIZATION ====================

        async function init() {
            try {
                // Load gamemaster.json
                await loadGameMaster();

                // Load available metas
                await loadAvailableMetas();

                // Load initial rankings
                await loadRankings();

                // Setup event listeners
                setupEventListeners();
            } catch (error) {
                showError(`Initialization failed: ${error.message}`);
                console.error('Init error:', error);
            }
        }

        async function loadGameMaster() {
            const response = await fetch('https://raw.githubusercontent.com/pvpoke/pvpoke/master/src/data/gamemaster.json');
            if (!response.ok) throw new Error('Failed to load gamemaster.json');
            gamemaster = await response.json();
            populateTypeFilter();
        }

        async function loadAvailableMetas() {
            try {
                const response = await fetch('https://api.github.com/repos/pvpoke/pvpoke/contents/src/data/rankings');
                if (!response.ok) throw new Error('Failed to fetch metas list');
                const contents = await response.json();

                const metas = contents
                    .filter(item => item.type === 'file' && item.name.endsWith('.json'))
                    .map(item => item.name.replace('.json', ''))
                    .sort();

                const metaSelect = document.getElementById('metaSelect');
                metaSelect.innerHTML = '';

                metas.forEach(meta => {
                    const option = document.createElement('option');
                    option.value = meta;
                    option.textContent = meta.split('_').map(word =>
                        word.charAt(0).toUpperCase() + word.slice(1)
                    ).join(' ');
                    metaSelect.appendChild(option);
                });

                if (metas.length > 0) {
                    metaSelect.value = metas[0];
                }
            } catch (error) {
                showError(`Failed to load available metas: ${error.message}`);
            }
        }

        async function loadRankings() {
            try {
                const league = document.getElementById('leagueSelect').value;
                const meta = document.getElementById('metaSelect').value;
                const cp = league === 'custom' ? document.getElementById('customCP').value : null;

                if (league === 'custom' && !cp) {
                    showError('Please enter a custom CP value');
                    return;
                }

                showLoading();

                // Build ranking file path
                let fileName = meta;
                if (league !== 'custom') {
                    fileName += `_${league}`;
                }

                const response = await fetch(
                    `https://raw.githubusercontent.com/pvpoke/pvpoke/master/src/data/rankings/${fileName}.json`
                );

                if (!response.ok) {
                    throw new Error(`Rankings not available for ${meta} ${league}`);
                }

                const data = await response.json();
                rankings = data.map((pokemon, index) => ({
                    ...pokemon,
                    rank: index + 1
                }));

                // Apply filters
                applyFilters();
                renderTable();
            } catch (error) {
                showError(`Failed to load rankings: ${error.message}`);
                rankings = [];
            }
        }

        // ==================== FILTERING & SORTING ====================

        function applyFilters() {
            let filtered = [...rankings];

            // Type filter
            const typeFilter = document.getElementById('typeFilter').value;
            if (typeFilter) {
                filtered = filtered.filter(p => {
                    const pokemon = gamemaster.pokemon.find(x => x.speciesId === p.speciesId);
                    return pokemon && pokemon.types.includes(typeFilter);
                });
            }

            // Role filter
            const roleFilter = document.getElementById('roleFilter').value;
            if (roleFilter) {
                filtered = filtered.filter(p => {
                    const role = identifyRole(p);
                    return role.toLowerCase() === roleFilter.toLowerCase();
                });
            }

            // Generation filter
            const genFilter = document.getElementById('genFilter').value;
            if (genFilter) {
                const [minDex, maxDex] = generations[genFilter];
                filtered = filtered.filter(p => p.dex >= minDex && p.dex <= maxDex);
            }

            // Apply sorting
            filtered.sort((a, b) => {
                let aVal = a[currentSort.field];
                let bVal = b[currentSort.field];

                // Handle numeric comparisons
                if (typeof aVal === 'number' && typeof bVal === 'number') {
                    return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                }

                // Handle string comparisons
                if (typeof aVal === 'string' && typeof bVal === 'string') {
                    return currentSort.direction === 'asc'
                        ? aVal.localeCompare(bVal)
                        : bVal.localeCompare(aVal);
                }

                return 0;
            });

            filteredRankings = filtered;
            currentPage = 1;
        }

        function sortTable(field) {
            const newDirection = currentSort.field === field && currentSort.direction === 'asc' ? 'desc' : 'asc';
            currentSort = { field, direction: newDirection };

            // Update header styling
            document.querySelectorAll('.rankings-table th').forEach(th => {
                th.classList.remove('active', 'desc');
            });

            const headers = document.querySelectorAll('.rankings-table th');
            const headerIndex = ['rank', 'name', 'score', 'consistency', 'tdo', 'bulk', 'role', 'type'].indexOf(field);
            if (headerIndex >= 0) {
                headers[headerIndex].classList.add('active');
                if (newDirection === 'desc') {
                    headers[headerIndex].classList.add('desc');
                }
            }

            applyFilters();
            renderTable();
        }

        // ==================== RENDERING ====================

        function renderTable() {
            const tbody = document.getElementById('rankingsBody');
            const start = (currentPage - 1) * itemsPerPage;
            const pageData = filteredRankings.slice(start, start + itemsPerPage);

            if (pageData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="status-message">
                    ${filteredRankings.length === 0 ? 'No Pokemon match your filters' : 'Loading...'}
                </td></tr>`;
                return;
            }

            tbody.innerHTML = pageData.map(pokemon => {
                const gmPokemon = gamemaster.pokemon.find(p => p.speciesId === pokemon.speciesId);
                if (!gmPokemon) return '';

                const isFavorite = isFavoritePokemon(pokemon.speciesId);
                const role = identifyRole(pokemon);
                const moves = getSuggestedMoves(pokemon, gmPokemon);

                return `
                    <tr>
                        <td class="rank-cell">#${pokemon.rank}</td>
                        <td class="pokemon-cell">
                            <div class="pokemon-sprite">
                                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${gmPokemon.dex}.png"
                                     alt="${gmPokemon.speciesName}" onerror="this.style.display='none'">
                            </div>
                            <div class="pokemon-info">
                                <h3>${gmPokemon.speciesName}</h3>
                                <div class="types">
                                    ${gmPokemon.types.map(t => `<span class="type-badge ${t}">${t}</span>`).join('')}
                                </div>
                            </div>
                            <div class="preview-popup">
                                <div class="preview-header">
                                    <div class="preview-sprite">
                                        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${gmPokemon.dex}.png"
                                             alt="${gmPokemon.speciesName}" onerror="this.style.display='none'">
                                    </div>
                                    <div class="preview-info">
                                        <h3>${gmPokemon.speciesName}</h3>
                                        <div class="types">
                                            ${gmPokemon.types.map(t => `<span class="type-badge ${t}" style="font-size: 0.7em;">${t}</span>`).join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="preview-stats">
                                    <div class="stat-item">
                                        <label>ATK</label>
                                        <div class="value">${gmPokemon.baseStats.atk}</div>
                                    </div>
                                    <div class="stat-item">
                                        <label>DEF</label>
                                        <div class="value">${gmPokemon.baseStats.def}</div>
                                    </div>
                                    <div class="stat-item">
                                        <label>HP</label>
                                        <div class="value">${gmPokemon.baseStats.hp}</div>
                                    </div>
                                </div>
                                <div class="move-suggestions">
                                    <h4>Top Moves</h4>
                                    <div class="moves-list">
                                        ${moves.slice(0, 4).map(move => `
                                            <div class="move-item">
                                                <span class="move-name">${move.name}</span>
                                                <span class="move-type">${move.type}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="score-cell">${pokemon.score ? pokemon.score.toFixed(1) : 'N/A'}</td>
                        <td><span class="stat-bar" style="width: ${(pokemon.consistency || 0) * 100}px;"><span class="stat-bar-label">${(pokemon.consistency || 0).toFixed(2)}</span></span></td>
                        <td>${pokemon.tdo ? pokemon.tdo.toFixed(0) : 'N/A'}</td>
                        <td>${pokemon.bulk ? pokemon.bulk.toFixed(0) : 'N/A'}</td>
                        <td><span class="role-badge">${role}</span></td>
                        <td>
                            <button class="secondary" onclick="toggleFavorite('${pokemon.speciesId}', '${gmPokemon.speciesName}')"
                                    style="padding: 5px 10px; font-size: 1.2em; min-width: auto; width: auto;">
                                ${isFavorite ? '❤' : '🤍'}
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            renderPagination();
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredRankings.length / itemsPerPage);
            const container = document.getElementById('paginationContainer');

            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '<button onclick="goToPage(1)">First</button>';

            if (currentPage > 1) {
                html += `<button onclick="goToPage(${currentPage - 1})">Previous</button>`;
            }

            const start = Math.max(1, currentPage - 2);
            const end = Math.min(totalPages, currentPage + 2);

            if (start > 1) html += '<span>...</span>';

            for (let i = start; i <= end; i++) {
                html += `<button onclick="goToPage(${i})" style="${i === currentPage ? 'background: #667eea;' : ''}">${i}</button>`;
            }

            if (end < totalPages) html += '<span>...</span>';

            if (currentPage < totalPages) {
                html += `<button onclick="goToPage(${currentPage + 1})">Next</button>`;
            }

            html += `<button onclick="goToPage(${totalPages})">Last</button>`;
            html += `<span>Page ${currentPage} of ${totalPages}</span>`;

            container.innerHTML = html;
        }

        // ==================== UTILITIES ====================

        function identifyRole(pokemon) {
            if (!pokemon.moveset) return 'Mixed';

            const consistency = pokemon.consistency || 0;
            const tdo = pokemon.tdo || 0;

            if (consistency > 0.65) return 'Bulky';
            if (tdo > 2000) return 'Attacker';
            if (consistency > 0.55) return 'Switcher';
            return 'Charmer';
        }

        function getSuggestedMoves(pokemon, gmPokemon) {
            if (!pokemon.moveset || !Array.isArray(pokemon.moveset)) {
                return [];
            }

            return pokemon.moveset.slice(0, 10).map(moveId => {
                const move = gamemaster.moves.find(m => m.moveId === moveId);
                return {
                    name: move ? move.name : moveId,
                    type: move ? move.type : 'unknown'
                };
            });
        }

        function populateTypeFilter() {
            const types = [...new Set(gamemaster.pokemon.flatMap(p => p.types))].sort();
            const select = document.getElementById('typeFilter');

            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                select.appendChild(option);
            });
        }

        // ==================== FAVORITES MANAGEMENT ====================

        function toggleFavorite(speciesId, name) {
            let favorites = JSON.parse(localStorage.getItem('pokemonFavorites') || '[]');
            const index = favorites.findIndex(f => f.id === speciesId);

            if (index >= 0) {
                favorites.splice(index, 1);
            } else {
                favorites.push({ id: speciesId, name });
            }

            localStorage.setItem('pokemonFavorites', JSON.stringify(favorites));
            renderTable();
            renderFavorites();
        }

        function isFavoritePokemon(speciesId) {
            const favorites = JSON.parse(localStorage.getItem('pokemonFavorites') || '[]');
            return favorites.some(f => f.id === speciesId);
        }

        function renderFavorites() {
            const favorites = JSON.parse(localStorage.getItem('pokemonFavorites') || '[]');
            const container = document.getElementById('favoritesList');

            if (favorites.length === 0) {
                container.innerHTML = '<p style="color: #aaa; text-align: center;">No favorites yet</p>';
                return;
            }

            container.innerHTML = favorites.map(fav => `
                <div class="favorite-item">
                    <span class="favorite-item-name">${fav.name}</span>
                    <button class="favorite-item-remove" onclick="removeFavorite('${fav.id}')">✕</button>
                </div>
            `).join('');
        }

        function removeFavorite(speciesId) {
            let favorites = JSON.parse(localStorage.getItem('pokemonFavorites') || '[]');
            favorites = favorites.filter(f => f.id !== speciesId);
            localStorage.setItem('pokemonFavorites', JSON.stringify(favorites));
            renderTable();
            renderFavorites();
        }

        function toggleFavorites() {
            const sidebar = document.getElementById('favoritesSidebar');
            sidebar.classList.toggle('active');
            renderFavorites();
        }

        // ==================== EXPORT ====================

        function exportToCSV() {
            if (filteredRankings.length === 0) {
                showError('No Pokemon to export');
                return;
            }

            const headers = ['Rank', 'Pokemon', 'Type', 'Score', 'Consistency', 'TDO', 'Bulk', 'Role'];
            const rows = filteredRankings.map(pokemon => {
                const gmPokemon = gamemaster.pokemon.find(p => p.speciesId === pokemon.speciesId);
                if (!gmPokemon) return null;

                return [
                    pokemon.rank,
                    gmPokemon.speciesName,
                    gmPokemon.types.join('/'),
                    (pokemon.score || 'N/A').toFixed(1),
                    (pokemon.consistency || 'N/A').toFixed(2),
                    (pokemon.tdo || 'N/A').toFixed(0),
                    (pokemon.bulk || 'N/A').toFixed(0),
                    identifyRole(pokemon)
                ];
            }).filter(r => r);

            let csv = headers.join(',') + '\n';
            csv += rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rankings-${document.getElementById('metaSelect').value}-${document.getElementById('leagueSelect').value}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            showSuccess(`Exported ${rows.length} Pokemon to CSV`);
        }

        function saveList() {
            const favorites = JSON.parse(localStorage.getItem('pokemonFavorites') || '[]');
            if (favorites.length === 0) {
                showError('No favorites to save');
                return;
            }

            const timestamp = new Date().toLocaleString();
            const lists = JSON.parse(localStorage.getItem('pokemonLists') || '[]');
            lists.push({
                name: `List - ${timestamp}`,
                pokemon: favorites,
                created: new Date().toISOString()
            });
            localStorage.setItem('pokemonLists', JSON.stringify(lists));
            showSuccess('Favorites list saved!');
        }

        function loadList() {
            const lists = JSON.parse(localStorage.getItem('pokemonLists') || '[]');
            if (lists.length === 0) {
                showError('No saved lists');
                return;
            }

            const listNames = lists.map((l, i) => `${i + 1}. ${l.name}`).join('\n');
            const selected = prompt(`Select a list:\n\n${listNames}\n\nEnter number:`, '1');

            if (selected && /^\d+$/.test(selected)) {
                const listIndex = parseInt(selected) - 1;
                if (listIndex >= 0 && listIndex < lists.length) {
                    localStorage.setItem('pokemonFavorites', JSON.stringify(lists[listIndex].pokemon));
                    renderTable();
                    renderFavorites();
                    showSuccess('List loaded!');
                }
            }
        }

        // ==================== UI HELPERS ====================

        function setupEventListeners() {
            document.getElementById('leagueSelect').addEventListener('change', loadRankings);
            document.getElementById('metaSelect').addEventListener('change', loadRankings);
            document.getElementById('customCP').addEventListener('change', loadRankings);
            document.getElementById('typeFilter').addEventListener('change', () => {
                applyFilters();
                renderTable();
            });
            document.getElementById('roleFilter').addEventListener('change', () => {
                applyFilters();
                renderTable();
            });
            document.getElementById('genFilter').addEventListener('change', () => {
                applyFilters();
                renderTable();
            });

            document.getElementById('favoritesBtn').addEventListener('click', toggleFavorites);
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);
            document.getElementById('resetBtn').addEventListener('click', () => {
                document.getElementById('leagueSelect').value = 'great';
                document.getElementById('typeFilter').value = '';
                document.getElementById('roleFilter').value = '';
                document.getElementById('genFilter').value = '';
                applyFilters();
                renderTable();
                showSuccess('Filters reset');
            });
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredRankings.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderTable();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function showLoading() {
            const container = document.getElementById('statusContainer');
            container.innerHTML = '';
        }

        function showError(message) {
            const container = document.getElementById('statusContainer');
            container.innerHTML = `<div class="error-message">⚠ ${message}</div>`;
        }

        function showSuccess(message) {
            const container = document.getElementById('statusContainer');
            container.innerHTML = `<div class="success-message">✓ ${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }

        // Start application
        init();
    </script>
</body>
</html>
