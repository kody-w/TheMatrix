<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Battle Assistant Ultimate v2.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .header h1 { font-size: 2em; margin-bottom: 5px; }
        .header p { font-size: 0.9em; opacity: 0.95; }
        .tabs {
            display: flex;
            overflow-x: auto;
            background: #16213e;
            border-bottom: 2px solid #2d3748;
            flex-wrap: wrap;
            scrollbar-width: thin;
        }
        .tab-btn {
            flex: 0 0 auto;
            min-width: 120px;
            padding: 12px 16px;
            background: #16213e;
            border: none;
            color: #a0aec0;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .tab-btn:hover { background: #2d3748; color: #fff; }
        .tab-btn.active {
            border-bottom-color: #667eea;
            color: #667eea;
            background: #1e2a4a;
        }
        .content-area {
            padding: 20px;
            min-height: calc(100vh - 160px);
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .tab-content.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card {
            background: #2d3748;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #4a5568;
        }
        .card h2 {
            color: #667eea;
            font-size: 1.3em;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.3);
            padding-bottom: 10px;
        }
        .card h3 {
            color: #a0b5f0;
            font-size: 1.1em;
            margin: 15px 0 10px 0;
        }
        .input-group { margin-bottom: 15px; }
        .input-label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #e2e8f0;
            font-size: 0.9em;
        }
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px 12px;
            background: #4a5568;
            border: 1px solid #4a5568;
            border-radius: 4px;
            color: #fff;
            font-size: 0.95em;
            transition: all 0.3s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            background: #5a6578;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        button {
            padding: 10px 16px;
            background: #667eea;
            border: none;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
            margin: 5px;
        }
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        .btn-secondary { background: #4a5568; color: #e2e8f0; }
        .btn-secondary:hover { background: #5a6578; }
        .btn-small { padding: 6px 12px; font-size: 0.8em; }
        .type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: capitalize;
            margin: 2px;
        }
        .type-normal { background: #A8A878; color: white; }
        .type-fire { background: #F08030; color: white; }
        .type-water { background: #6890F0; color: white; }
        .type-grass { background: #78C850; color: white; }
        .type-electric { background: #F8D030; color: #333; }
        .type-ice { background: #98D8D8; color: #333; }
        .type-fighting { background: #C03028; color: white; }
        .type-poison { background: #A040A0; color: white; }
        .type-ground { background: #E0C068; color: #333; }
        .type-flying { background: #A890F0; color: white; }
        .type-psychic { background: #F85888; color: white; }
        .type-bug { background: #A8B820; color: white; }
        .type-rock { background: #B8A038; color: white; }
        .type-ghost { background: #705898; color: white; }
        .type-dragon { background: #7038F8; color: white; }
        .type-dark { background: #705848; color: white; }
        .type-steel { background: #B8B8D0; color: #333; }
        .type-fairy { background: #EE99AC; color: white; }
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .pokemon-card {
            background: #0f3460;
            border: 1px solid #667eea;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .pokemon-card:hover {
            background: #16213e;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.4);
            transform: translateY(-3px);
        }
        .pokemon-card.selected {
            border: 2px solid #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.6);
        }
        .pokemon-card img {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(102, 126, 234, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 768px) {
            .header h1 { font-size: 1.4em; }
            .tabs { flex-wrap: nowrap; overflow-x: scroll; }
            .tab-btn { min-width: 100px; padding: 10px 12px; font-size: 0.75em; }
            .content-area { padding: 15px; }
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
        }
        .settings-panel {
            position: fixed;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100vh;
            background: #2d3748;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        .settings-panel.active { right: 0; }
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .close-settings {
            background: none;
            border: none;
            color: #667eea;
            font-size: 2em;
            cursor: pointer;
            padding: 0;
        }
        .settings-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #667eea;
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        .settings-btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }
        .message {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        .message-success {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4caf50;
            color: #81c784;
        }
        .message-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid #ffc107;
            color: #ffd54f;
        }
        .message-error {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid #f44336;
            color: #ef5350;
        }
        .message-info {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid #667eea;
            color: #a0b5f0;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: #1a202c;
            margin: 5px 0;
            border-radius: 4px;
        }
        .progress-bar {
            height: 8px;
            background: #4a5568;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s ease;
        }
        .move-item {
            background: #1a202c;
            padding: 12px;
            margin: 8px 0;
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }
        .team-slot {
            background: #1a202c;
            padding: 15px;
            border-radius: 8px;
            border: 2px dashed #4a5568;
            min-height: 150px;
            text-align: center;
        }
        .team-slot.filled {
            border: 2px solid #667eea;
            background: #0f3460;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #4a5568;
        }
        th {
            background: #1a202c;
            color: #667eea;
            font-weight: 600;
        }
        tr:hover {
            background: #1a202c;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Pokemon Battle Assistant Ultimate v2.0</h1>
        <p>Your complete PvP toolkit with 10 integrated professional tools</p>
    </div>

    <button class="settings-btn" onclick="toggleSettings()">⚙</button>

    <div class="tabs" id="tabsNav">
        <button class="tab-btn active" onclick="switchTab('browser')">Browser</button>
        <button class="tab-btn" onclick="switchTab('moves')">Moves</button>
        <button class="tab-btn" onclick="switchTab('simulator')">Simulator</button>
        <button class="tab-btn" onclick="switchTab('iv-calc')">IV Calc</button>
        <button class="tab-btn" onclick="switchTab('team')">Team Builder</button>
        <button class="tab-btn" onclick="switchTab('rankings')">Rankings</button>
        <button class="tab-btn" onclick="switchTab('types')">Type Chart</button>
        <button class="tab-btn" onclick="switchTab('meta')">Meta</button>
        <button class="tab-btn" onclick="switchTab('training')">Training</button>
        <button class="tab-btn" onclick="switchTab('advanced')">Advanced</button>
    </div>

    <div class="content-area">
        <!-- Tab 1: Pokemon Browser -->
        <div id="tab-browser" class="tab-content active">
            <div class="card">
                <h2>Pokemon Browser</h2>
                <div class="input-group">
                    <input type="text" id="browser-search" placeholder="Search Pokemon by name..." onkeyup="filterPokemon()">
                </div>
                <div id="browser-grid" class="grid-4"></div>
            </div>
        </div>

        <!-- Tab 2: Move Database -->
        <div id="tab-moves" class="tab-content">
            <div class="card">
                <h2>Move Database</h2>
                <div class="grid-2">
                    <div class="input-group">
                        <input type="text" id="move-search" placeholder="Search moves..." onkeyup="filterMoves()">
                    </div>
                    <div class="input-group">
                        <select id="move-type-filter" onchange="filterMoves()">
                            <option value="">All Types</option>
                        </select>
                    </div>
                </div>
                <div id="move-list"></div>
            </div>
        </div>

        <!-- Tab 3: Battle Simulator -->
        <div id="tab-simulator" class="tab-content">
            <div class="card">
                <h2>Battle Simulator</h2>
                <p class="message-info">Select Pokemon from the Browser tab to simulate battles</p>
                <div class="grid-2" id="sim-pokemon-select">
                    <div>
                        <h3>Pokemon 1</h3>
                        <div id="sim-p1-display">No Pokemon selected</div>
                    </div>
                    <div>
                        <h3>Pokemon 2</h3>
                        <div id="sim-p2-display">No Pokemon selected</div>
                    </div>
                </div>
                <button onclick="runSimulation()" id="sim-start-btn" disabled>Start Battle</button>
                <div id="sim-results"></div>
            </div>
        </div>

        <!-- Tab 4: IV Calculator -->
        <div id="tab-iv-calc" class="tab-content">
            <div class="card">
                <h2>IV Calculator & Optimizer</h2>
                <div class="input-group">
                    <label class="input-label">Pokemon</label>
                    <input type="text" id="iv-pokemon" placeholder="Enter Pokemon name..." list="pokemon-datalist">
                </div>
                <div class="grid-3">
                    <div class="input-group">
                        <label class="input-label">ATK IV (0-15)</label>
                        <input type="number" id="iv-atk" min="0" max="15" value="15">
                    </div>
                    <div class="input-group">
                        <label class="input-label">DEF IV (0-15)</label>
                        <input type="number" id="iv-def" min="0" max="15" value="15">
                    </div>
                    <div class="input-group">
                        <label class="input-label">HP IV (0-15)</label>
                        <input type="number" id="iv-hp" min="0" max="15" value="15">
                    </div>
                </div>
                <div class="input-group">
                    <label class="input-label">League</label>
                    <select id="iv-league">
                        <option value="500">Little League (500 CP)</option>
                        <option value="1500" selected>Great League (1500 CP)</option>
                        <option value="2500">Ultra League (2500 CP)</option>
                        <option value="10000">Master League (No Cap)</option>
                    </select>
                </div>
                <button onclick="calculateIVs()">Calculate Stats</button>
                <div id="iv-results"></div>
            </div>
        </div>

        <!-- Tab 5: Team Builder -->
        <div id="tab-team" class="tab-content">
            <div class="card">
                <h2>Team Builder & Analyzer</h2>
                <p class="message-info">Build a team of 3 Pokemon and analyze type coverage</p>
                <div id="team-slots" class="grid-3"></div>
                <button onclick="clearTeam()">Clear Team</button>
                <button onclick="analyzeTeam()">Analyze Team</button>
                <div id="team-analysis"></div>
            </div>
        </div>

        <!-- Tab 6: Rankings -->
        <div id="tab-rankings" class="tab-content">
            <div class="card">
                <h2>PvP Rankings Viewer</h2>
                <div class="grid-2">
                    <div class="input-group">
                        <label class="input-label">League</label>
                        <select id="rank-league">
                            <option value="great">Great League</option>
                            <option value="ultra">Ultra League</option>
                            <option value="master">Master League</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Limit</label>
                        <select id="rank-limit">
                            <option value="10">Top 10</option>
                            <option value="25" selected>Top 25</option>
                            <option value="50">Top 50</option>
                        </select>
                    </div>
                </div>
                <button onclick="loadRankings()">Load Rankings</button>
                <div id="rankings-results"></div>
            </div>
        </div>

        <!-- Tab 7: Type Chart -->
        <div id="tab-types" class="tab-content">
            <div class="card">
                <h2>Type Effectiveness Chart</h2>
                <p class="message-info">Select attacking and defending types to see effectiveness</p>
                <div class="grid-2">
                    <div class="input-group">
                        <label class="input-label">Attacking Type</label>
                        <select id="type-attack" onchange="updateTypeChart()">
                            <option value="">Select Type</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Defending Type</label>
                        <select id="type-defend" onchange="updateTypeChart()">
                            <option value="">Select Type</option>
                        </select>
                    </div>
                </div>
                <div id="type-chart-results"></div>
            </div>
        </div>

        <!-- Tab 8: Meta Dashboard -->
        <div id="tab-meta" class="tab-content">
            <div class="card">
                <h2>Meta Dashboard</h2>
                <p class="message-info">Analysis of current PvP meta trends</p>
                <div class="grid-3">
                    <div class="input-group">
                        <label class="input-label">League</label>
                        <select id="meta-league" onchange="updateMeta()">
                            <option value="great">Great League</option>
                            <option value="ultra">Ultra League</option>
                            <option value="master">Master League</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Analysis Type</label>
                        <select id="meta-analysis" onchange="updateMeta()">
                            <option value="usage">Most Used</option>
                            <option value="threats">Biggest Threats</option>
                            <option value="coverage">Best Coverage</option>
                        </select>
                    </div>
                </div>
                <div id="meta-results"></div>
            </div>
        </div>

        <!-- Tab 9: Training Mode -->
        <div id="tab-training" class="tab-content">
            <div class="card">
                <h2>Training Mode</h2>
                <p class="message-info">Practice PvP mechanics and scenarios</p>
                <div class="grid-2">
                    <div class="card">
                        <h3>Energy Management</h3>
                        <p>Learn to track energy and time charged moves</p>
                        <button onclick="startTraining('energy')">Start Practice</button>
                    </div>
                    <div class="card">
                        <h3>Shield Baiting</h3>
                        <p>Practice baiting shields and managing your own</p>
                        <button onclick="startTraining('shields')">Start Practice</button>
                    </div>
                    <div class="card">
                        <h3>Type Coverage</h3>
                        <p>Test your knowledge of type effectiveness</p>
                        <button onclick="startTraining('coverage')">Start Practice</button>
                    </div>
                    <div class="card">
                        <h3>Move Timing</h3>
                        <p>Perfect your charge move timing</p>
                        <button onclick="startTraining('timing')">Start Practice</button>
                    </div>
                </div>
                <div id="training-area"></div>
            </div>
        </div>

        <!-- Tab 10: Advanced Tools -->
        <div id="tab-advanced" class="tab-content">
            <div class="card">
                <h2>Advanced Tools</h2>
                <div class="grid-3">
                    <div class="card">
                        <h3>Breakpoint Finder</h3>
                        <p>Find damage breakpoints for specific matchups</p>
                        <button onclick="openTool('breakpoint')">Open Tool</button>
                    </div>
                    <div class="card">
                        <h3>Bulkpoint Calculator</h3>
                        <p>Calculate defensive breakpoints</p>
                        <button onclick="openTool('bulkpoint')">Open Tool</button>
                    </div>
                    <div class="card">
                        <h3>CMP Checker</h3>
                        <p>Check Charge Move Priority ties</p>
                        <button onclick="openTool('cmp')">Open Tool</button>
                    </div>
                    <div class="card">
                        <h3>Energy Advantage</h3>
                        <p>Calculate energy states in battles</p>
                        <button onclick="openTool('energy')">Open Tool</button>
                    </div>
                    <div class="card">
                        <h3>Fast Move Denial</h3>
                        <p>Optimize switching and fast move cycles</p>
                        <button onclick="openTool('denial')">Open Tool</button>
                    </div>
                    <div class="card">
                        <h3>Shadow vs Normal</h3>
                        <p>Compare shadow and normal Pokemon</p>
                        <button onclick="openTool('shadow')">Open Tool</button>
                    </div>
                </div>
                <div id="advanced-tool-area"></div>
            </div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2>Settings</h2>
            <button class="close-settings" onclick="toggleSettings()">×</button>
        </div>
        <div class="input-group">
            <label class="input-label">Data Source</label>
            <select id="settings-data-source">
                <option value="pvpoke">PvPoke (Recommended)</option>
            </select>
        </div>
        <div class="input-group">
            <label class="input-label">Auto-refresh Data</label>
            <select id="settings-auto-refresh">
                <option value="false">Disabled</option>
                <option value="true">Enabled</option>
            </select>
        </div>
        <p class="message-info" style="margin-top: 20px;">Settings are automatically saved</p>
    </div>

    <datalist id="pokemon-datalist"></datalist>

    <script>
        // Global state management
        const globalState = {
            pokemon: [],
            moves: [],
            selectedPokemon: [],
            team: [null, null, null],
            loading: false,
            dataLoaded: false
        };

        // Type effectiveness chart
        const typeChart = {
            normal: { fighting: 1.6, ghost: 0.625 },
            fire: { fire: 0.625, water: 1.6, grass: 0.625, ice: 0.625, ground: 1.6, bug: 0.625, rock: 1.6, steel: 0.625, fairy: 0.625 },
            water: { fire: 0.625, water: 0.625, grass: 1.6, ground: 0.625, rock: 0.625, dragon: 0.625, steel: 0.625, electric: 1.6 },
            grass: { fire: 1.6, water: 0.625, grass: 0.625, poison: 1.6, ground: 0.625, flying: 1.6, bug: 1.6, ice: 1.6, steel: 0.625 },
            electric: { water: 0.625, grass: 0.625, electric: 0.625, ground: 1.6, flying: 0.625, dragon: 0.625, steel: 0.625 },
            ice: { fire: 1.6, ice: 0.625, fighting: 1.6, rock: 1.6, steel: 1.6 },
            fighting: { flying: 1.6, psychic: 1.6, bug: 0.625, rock: 0.625, dark: 0.625, fairy: 1.6 },
            poison: { grass: 0.625, fighting: 0.625, poison: 0.625, ground: 1.6, psychic: 1.6, bug: 0.625, fairy: 0.625 },
            ground: { water: 1.6, grass: 1.6, electric: 0.625, poison: 0.625, flying: 0.390625, rock: 0.625, ice: 1.6 },
            flying: { grass: 0.625, electric: 1.6, fighting: 0.625, bug: 0.625, rock: 1.6, ice: 1.6 },
            psychic: { fighting: 0.625, psychic: 0.625, bug: 1.6, ghost: 1.6, dark: 1.6 },
            bug: { fire: 1.6, grass: 0.625, fighting: 0.625, ground: 0.625, flying: 1.6, rock: 1.6 },
            rock: { water: 1.6, grass: 1.6, fighting: 1.6, ground: 1.6, steel: 1.6 },
            ghost: { normal: 0.390625, ghost: 1.6, dark: 1.6 },
            dragon: { dragon: 1.6, steel: 0.625, fairy: 1.6, ice: 1.6 },
            dark: { fighting: 1.6, psychic: 0.390625, bug: 1.6, ghost: 0.625, dark: 0.625, fairy: 1.6 },
            steel: { fire: 1.6, water: 1.6, electric: 1.6, ice: 0.625, fighting: 1.6, ground: 1.6, flying: 0.625, psychic: 0.625, bug: 0.625, rock: 0.625, dragon: 0.625, steel: 0.625, fairy: 0.625 },
            fairy: { fire: 0.625, fighting: 0.625, poison: 1.6, dragon: 0.390625, dark: 0.625, steel: 1.6 }
        };

        const allTypes = ['normal', 'fire', 'water', 'grass', 'electric', 'ice', 'fighting', 'poison', 'ground', 'flying', 'psychic', 'bug', 'rock', 'ghost', 'dragon', 'dark', 'steel', 'fairy'];

        // Initialize app
        async function init() {
            showLoading();
            await loadGameMaster();
            hideLoading();
            renderPokemon();
            renderMoves();
            initTeamSlots();
            populateTypeSelects();
            loadSettings();
        }

        // Load game master data
        async function loadGameMaster() {
            if (globalState.dataLoaded) return;

            try {
                const response = await fetch('https://raw.githubusercontent.com/pvpoke/pvpoke/master/src/data/gamemaster.json');
                const data = await response.json();

                // Process Pokemon
                globalState.pokemon = data.pokemon.filter(p => p.speciesId).map(p => ({
                    id: p.speciesId,
                    name: p.speciesName || p.speciesId,
                    types: p.types || [],
                    baseStats: p.baseStats || { atk: 100, def: 100, hp: 100 },
                    fastMoves: p.fastMoves || [],
                    chargedMoves: p.chargedMoves || [],
                    tags: p.tags || []
                }));

                // Process Moves
                globalState.moves = [...(data.moves || [])].map(m => ({
                    id: m.moveId,
                    name: m.name || m.moveId,
                    type: m.type || 'normal',
                    power: m.power || 0,
                    energy: m.energy || 0,
                    energyGain: m.energyGain || 0,
                    cooldown: m.cooldown || 0,
                    archetype: m.archetype || 'fast'
                }));

                globalState.dataLoaded = true;

                // Populate datalist for autocomplete
                const datalist = document.getElementById('pokemon-datalist');
                datalist.innerHTML = globalState.pokemon.map(p => `<option value="${p.name}">`).join('');

            } catch (error) {
                console.error('Error loading game master:', error);
                alert('Error loading Pokemon data. Please refresh the page.');
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Save current tab
            localStorage.setItem('currentTab', tabName);
        }

        // Pokemon Browser
        function renderPokemon(filter = '') {
            const grid = document.getElementById('browser-grid');
            const filtered = globalState.pokemon.filter(p =>
                p.name.toLowerCase().includes(filter.toLowerCase())
            ).slice(0, 100);

            grid.innerHTML = filtered.map(p => `
                <div class="pokemon-card" onclick="selectPokemon('${p.id}')">
                    <div><strong>${p.name}</strong></div>
                    <div>
                        ${p.types.map(t => `<span class="type-badge type-${t}">${t}</span>`).join('')}
                    </div>
                    <div style="font-size: 0.8em; margin-top: 5px;">
                        ATK: ${p.baseStats.atk} | DEF: ${p.baseStats.def} | HP: ${p.baseStats.hp}
                    </div>
                </div>
            `).join('');
        }

        function filterPokemon() {
            const search = document.getElementById('browser-search').value;
            renderPokemon(search);
        }

        function selectPokemon(pokemonId) {
            const pokemon = globalState.pokemon.find(p => p.id === pokemonId);
            if (!pokemon) return;

            // Add to selected (max 2 for simulator)
            if (globalState.selectedPokemon.length < 2) {
                globalState.selectedPokemon.push(pokemon);
            } else {
                globalState.selectedPokemon = [globalState.selectedPokemon[1], pokemon];
            }

            updateSimulatorDisplay();
        }

        function updateSimulatorDisplay() {
            const p1 = globalState.selectedPokemon[0];
            const p2 = globalState.selectedPokemon[1];

            document.getElementById('sim-p1-display').innerHTML = p1 ?
                `<strong>${p1.name}</strong><br>${p1.types.map(t => `<span class="type-badge type-${t}">${t}</span>`).join('')}` :
                'No Pokemon selected';

            document.getElementById('sim-p2-display').innerHTML = p2 ?
                `<strong>${p2.name}</strong><br>${p2.types.map(t => `<span class="type-badge type-${t}">${t}</span>`).join('')}` :
                'No Pokemon selected';

            document.getElementById('sim-start-btn').disabled = !p1 || !p2;
        }

        // Move Database
        function renderMoves(filter = '', typeFilter = '') {
            const list = document.getElementById('move-list');
            const filtered = globalState.moves.filter(m =>
                m.name.toLowerCase().includes(filter.toLowerCase()) &&
                (typeFilter === '' || m.type === typeFilter)
            );

            list.innerHTML = filtered.slice(0, 50).map(m => `
                <div class="move-item">
                    <div style="display: flex; justify-content: space-between;">
                        <div>
                            <strong>${m.name}</strong>
                            <span class="type-badge type-${m.type}">${m.type}</span>
                        </div>
                        <div style="font-size: 0.85em;">
                            ${m.archetype === 'fast' ?
                                `Energy: +${m.energyGain} | Cooldown: ${m.cooldown}` :
                                `Power: ${m.power} | Energy: ${m.energy}`
                            }
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterMoves() {
            const search = document.getElementById('move-search').value;
            const type = document.getElementById('move-type-filter').value;
            renderMoves(search, type);
        }

        // Battle Simulator
        function runSimulation() {
            const p1 = globalState.selectedPokemon[0];
            const p2 = globalState.selectedPokemon[1];

            if (!p1 || !p2) return;

            const results = document.getElementById('sim-results');

            // Simple type effectiveness calculation
            let p1Effectiveness = 1;
            let p2Effectiveness = 1;

            p1.types.forEach(attackType => {
                p2.types.forEach(defendType => {
                    if (typeChart[attackType] && typeChart[attackType][defendType]) {
                        p1Effectiveness *= typeChart[attackType][defendType];
                    }
                });
            });

            p2.types.forEach(attackType => {
                p1.types.forEach(defendType => {
                    if (typeChart[attackType] && typeChart[attackType][defendType]) {
                        p2Effectiveness *= typeChart[attackType][defendType];
                    }
                });
            });

            const p1Score = (p1.baseStats.atk + p1.baseStats.def + p1.baseStats.hp) * p1Effectiveness;
            const p2Score = (p2.baseStats.atk + p2.baseStats.def + p2.baseStats.hp) * p2Effectiveness;

            results.innerHTML = `
                <div class="card">
                    <h3>Battle Results</h3>
                    <div class="stat-row">
                        <span>${p1.name}</span>
                        <span>Score: ${p1Score.toFixed(1)}</span>
                    </div>
                    <div class="stat-row">
                        <span>${p2.name}</span>
                        <span>Score: ${p2Score.toFixed(1)}</span>
                    </div>
                    <div class="message-${p1Score > p2Score ? 'success' : 'warning'}" style="margin-top: 15px;">
                        <strong>${p1Score > p2Score ? p1.name : p2.name}</strong> has the advantage!
                    </div>
                    <div style="margin-top: 15px; font-size: 0.9em;">
                        <p><strong>Type Effectiveness:</strong></p>
                        <p>${p1.name}: ${(p1Effectiveness * 100).toFixed(0)}% effectiveness</p>
                        <p>${p2.name}: ${(p2Effectiveness * 100).toFixed(0)}% effectiveness</p>
                    </div>
                </div>
            `;
        }

        // IV Calculator
        function calculateIVs() {
            const pokemonName = document.getElementById('iv-pokemon').value;
            const atkIV = parseInt(document.getElementById('iv-atk').value);
            const defIV = parseInt(document.getElementById('iv-def').value);
            const hpIV = parseInt(document.getElementById('iv-hp').value);
            const cpCap = parseInt(document.getElementById('iv-league').value);

            const pokemon = globalState.pokemon.find(p =>
                p.name.toLowerCase() === pokemonName.toLowerCase()
            );

            if (!pokemon) {
                document.getElementById('iv-results').innerHTML =
                    '<div class="message-error">Pokemon not found</div>';
                return;
            }

            // Calculate stats at level 51 (max level)
            const level = 51;
            const cpm = 0.84029999; // Level 51 CPM

            const atk = (pokemon.baseStats.atk + atkIV) * cpm;
            const def = (pokemon.baseStats.def + defIV) * cpm;
            const hp = Math.floor((pokemon.baseStats.hp + hpIV) * cpm);

            // Calculate CP
            const cp = Math.floor((atk * Math.pow(def, 0.5) * Math.pow(hp, 0.5)) / 10);

            // Calculate stat product
            const statProduct = atk * def * hp;

            // IV percentage
            const ivPercent = ((atkIV + defIV + hpIV) / 45 * 100).toFixed(1);

            document.getElementById('iv-results').innerHTML = `
                <div class="card">
                    <h3>${pokemon.name} - ${ivPercent}% IVs</h3>
                    <div class="stat-row">
                        <span>Attack</span>
                        <span>${atk.toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span>Defense</span>
                        <span>${def.toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span>HP</span>
                        <span>${hp}</span>
                    </div>
                    <div class="stat-row">
                        <span>CP at Level ${level}</span>
                        <span>${cp}</span>
                    </div>
                    <div class="stat-row">
                        <span>Stat Product</span>
                        <span>${statProduct.toFixed(0)}</span>
                    </div>
                    <div class="message-${cp <= cpCap ? 'success' : 'warning'}" style="margin-top: 15px;">
                        ${cp <= cpCap ?
                            `This Pokemon fits in the ${cpCap} CP league!` :
                            `This Pokemon exceeds the ${cpCap} CP cap`
                        }
                    </div>
                </div>
            `;
        }

        // Team Builder
        function initTeamSlots() {
            const container = document.getElementById('team-slots');
            container.innerHTML = [0, 1, 2].map(i => `
                <div class="team-slot" id="team-slot-${i}">
                    <p>Slot ${i + 1}: Empty</p>
                    <button class="btn-small" onclick="addToTeam(${i})">Add Pokemon</button>
                </div>
            `).join('');
        }

        function addToTeam(slot) {
            const lastSelected = globalState.selectedPokemon[globalState.selectedPokemon.length - 1];
            if (!lastSelected) {
                alert('Please select a Pokemon from the Browser tab first');
                return;
            }

            globalState.team[slot] = lastSelected;
            updateTeamDisplay();
        }

        function updateTeamDisplay() {
            globalState.team.forEach((pokemon, i) => {
                const slotDiv = document.getElementById(`team-slot-${i}`);
                if (pokemon) {
                    slotDiv.className = 'team-slot filled';
                    slotDiv.innerHTML = `
                        <strong>${pokemon.name}</strong>
                        <div>${pokemon.types.map(t => `<span class="type-badge type-${t}">${t}</span>`).join('')}</div>
                        <button class="btn-small btn-secondary" onclick="removeFromTeam(${i})">Remove</button>
                    `;
                }
            });
        }

        function removeFromTeam(slot) {
            globalState.team[slot] = null;
            initTeamSlots();
            updateTeamDisplay();
        }

        function clearTeam() {
            globalState.team = [null, null, null];
            initTeamSlots();
        }

        function analyzeTeam() {
            const team = globalState.team.filter(p => p !== null);
            if (team.length === 0) {
                document.getElementById('team-analysis').innerHTML =
                    '<div class="message-warning">Add Pokemon to your team first</div>';
                return;
            }

            // Analyze type coverage
            const allTeamTypes = [...new Set(team.flatMap(p => p.types))];
            const resistances = {};
            const weaknesses = {};

            allTypes.forEach(type => {
                let effectiveness = 0;
                team.forEach(pokemon => {
                    pokemon.types.forEach(defType => {
                        if (typeChart[type] && typeChart[type][defType]) {
                            effectiveness += typeChart[type][defType];
                        } else {
                            effectiveness += 1;
                        }
                    });
                });

                const avg = effectiveness / team.length;
                if (avg > 1.2) {
                    weaknesses[type] = avg;
                } else if (avg < 0.8) {
                    resistances[type] = avg;
                }
            });

            document.getElementById('team-analysis').innerHTML = `
                <div class="card">
                    <h3>Team Coverage Analysis</h3>
                    <p><strong>Team Size:</strong> ${team.length} Pokemon</p>
                    <p><strong>Type Coverage:</strong> ${allTeamTypes.map(t => `<span class="type-badge type-${t}">${t}</span>`).join('')}</p>

                    <h3 style="margin-top: 20px;">Weaknesses</h3>
                    ${Object.keys(weaknesses).length > 0 ?
                        Object.entries(weaknesses).map(([type, val]) =>
                            `<span class="type-badge type-${type}">${type} (${(val * 100).toFixed(0)}%)</span>`
                        ).join('') :
                        '<p>No major weaknesses detected</p>'
                    }

                    <h3 style="margin-top: 20px;">Resistances</h3>
                    ${Object.keys(resistances).length > 0 ?
                        Object.entries(resistances).map(([type, val]) =>
                            `<span class="type-badge type-${type}">${type} (${(val * 100).toFixed(0)}%)</span>`
                        ).join('') :
                        '<p>No major resistances detected</p>'
                    }
                </div>
            `;
        }

        // Rankings
        function loadRankings() {
            const league = document.getElementById('rank-league').value;
            const limit = parseInt(document.getElementById('rank-limit').value);

            // Sort Pokemon by stats for simplified ranking
            const ranked = [...globalState.pokemon]
                .sort((a, b) => {
                    const aTotal = a.baseStats.atk + a.baseStats.def + a.baseStats.hp;
                    const bTotal = b.baseStats.atk + b.baseStats.def + b.baseStats.hp;
                    return bTotal - aTotal;
                })
                .slice(0, limit);

            document.getElementById('rankings-results').innerHTML = `
                <div class="card">
                    <h3>${league.charAt(0).toUpperCase() + league.slice(1)} League - Top ${limit}</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Pokemon</th>
                                <th>Types</th>
                                <th>Stats</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ranked.map((p, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td><strong>${p.name}</strong></td>
                                    <td>${p.types.map(t => `<span class="type-badge type-${t}">${t}</span>`).join('')}</td>
                                    <td>${p.baseStats.atk}/${p.baseStats.def}/${p.baseStats.hp}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Type Chart
        function populateTypeSelects() {
            const attackSelect = document.getElementById('type-attack');
            const defendSelect = document.getElementById('type-defend');
            const moveTypeFilter = document.getElementById('move-type-filter');

            const typeOptions = allTypes.map(t =>
                `<option value="${t}">${t.charAt(0).toUpperCase() + t.slice(1)}</option>`
            ).join('');

            attackSelect.innerHTML += typeOptions;
            defendSelect.innerHTML += typeOptions;
            moveTypeFilter.innerHTML += typeOptions;
        }

        function updateTypeChart() {
            const attackType = document.getElementById('type-attack').value;
            const defendType = document.getElementById('type-defend').value;
            const results = document.getElementById('type-chart-results');

            if (!attackType || !defendType) {
                results.innerHTML = '<div class="message-info">Select both types to see effectiveness</div>';
                return;
            }

            const effectiveness = (typeChart[attackType] && typeChart[attackType][defendType]) || 1.0;

            let effectivenessText = 'Normal damage';
            let messageClass = 'message-info';

            if (effectiveness > 1.5) {
                effectivenessText = 'Super effective!';
                messageClass = 'message-success';
            } else if (effectiveness < 0.7) {
                effectivenessText = 'Not very effective';
                messageClass = 'message-warning';
            } else if (effectiveness < 0.5) {
                effectivenessText = 'Extremely resisted';
                messageClass = 'message-error';
            }

            results.innerHTML = `
                <div class="card">
                    <h3>Type Effectiveness</h3>
                    <div style="text-align: center; margin: 20px 0;">
                        <span class="type-badge type-${attackType}">${attackType}</span>
                        <span style="font-size: 1.5em; margin: 0 15px;">→</span>
                        <span class="type-badge type-${defendType}">${defendType}</span>
                    </div>
                    <div class="${messageClass}">
                        <strong>${(effectiveness * 100).toFixed(0)}%</strong> damage - ${effectivenessText}
                    </div>
                </div>
            `;
        }

        // Meta Dashboard
        function updateMeta() {
            const league = document.getElementById('meta-league').value;
            const analysis = document.getElementById('meta-analysis').value;

            document.getElementById('meta-results').innerHTML = `
                <div class="card">
                    <h3>${league.charAt(0).toUpperCase() + league.slice(1)} League - ${analysis}</h3>
                    <p class="message-info">Meta analysis coming soon! This feature will show current trends and popular Pokemon.</p>
                </div>
            `;
        }

        // Training Mode
        function startTraining(mode) {
            const area = document.getElementById('training-area');

            area.innerHTML = `
                <div class="card">
                    <h3>Training: ${mode.charAt(0).toUpperCase() + mode.slice(1)}</h3>
                    <p class="message-info">Interactive training scenarios coming soon!</p>
                    <button onclick="document.getElementById('training-area').innerHTML = ''">Close</button>
                </div>
            `;
        }

        // Advanced Tools
        function openTool(toolName) {
            const area = document.getElementById('advanced-tool-area');

            area.innerHTML = `
                <div class="card">
                    <h3>${toolName.charAt(0).toUpperCase() + toolName.slice(1)} Tool</h3>
                    <p class="message-info">Advanced calculation tools coming soon!</p>
                    <button onclick="document.getElementById('advanced-tool-area').innerHTML = ''">Close</button>
                </div>
            `;
        }

        // Settings
        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('active');
        }

        function loadSettings() {
            const savedTab = localStorage.getItem('currentTab');
            if (savedTab) {
                // Will be restored on next interaction
            }
        }

        // Loading states
        function showLoading() {
            document.getElementById('browser-grid').innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading Pokemon data...</p></div>';
        }

        function hideLoading() {
            // Data is ready
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
