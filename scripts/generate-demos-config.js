#!/usr/bin/env node

/**
 * Auto-generates demos_config.json by scanning HTML files for demo metadata
 *
 * Usage: node scripts/generate-demos-config.js
 *
 * This script scans all HTML files in the project and looks for demo metadata
 * in <meta> tags, then automatically generates data/config/demos_config.json
 */

const fs = require('fs');
const path = require('path');
const { JSDOM } = require('jsdom');

// Configuration
const PROJECT_ROOT = path.join(__dirname, '..');
const OUTPUT_FILE = path.join(PROJECT_ROOT, 'data/config/demos_config.json');
const DEMO_PATHS = [
    'apps/games/pokemon',
    'apps/games',
    'apps',
    '.' // Root directory for backward compatibility
];

// Metadata keys to look for in HTML files
const META_KEYS = {
    demoId: 'demo:id',
    demoTitle: 'demo:title',
    demoDescription: 'demo:description',
    demoTags: 'demo:tags',
    demoStatus: 'demo:status',
    demoStatusLabel: 'demo:statusLabel'
};

/**
 * Extract demo metadata from HTML file
 */
function extractDemoMetadata(htmlPath) {
    try {
        const html = fs.readFileSync(htmlPath, 'utf8');
        const dom = new JSDOM(html);
        const document = dom.window.document;

        // Check if this file is marked as a demo
        const isDemoMeta = document.querySelector(`meta[name="${META_KEYS.demoId}"]`);
        if (!isDemoMeta) return null;

        // Extract metadata
        const metadata = {
            id: document.querySelector(`meta[name="${META_KEYS.demoId}"]`)?.getAttribute('content'),
            title: document.querySelector(`meta[name="${META_KEYS.demoTitle}"]`)?.getAttribute('content'),
            description: document.querySelector(`meta[name="${META_KEYS.demoDescription}"]`)?.getAttribute('content'),
            tags: document.querySelector(`meta[name="${META_KEYS.demoTags}"]`)?.getAttribute('content')?.split(',').map(t => t.trim()) || [],
            status: document.querySelector(`meta[name="${META_KEYS.demoStatus}"]`)?.getAttribute('content') || 'ready',
            statusLabel: document.querySelector(`meta[name="${META_KEYS.demoStatusLabel}"]`)?.getAttribute('content') || 'LIVE',
            path: path.relative(PROJECT_ROOT, htmlPath).replace(/\\/g, '/')
        };

        // Validate required fields
        if (!metadata.id || !metadata.title) {
            console.warn(`âš ï¸  Skipping ${htmlPath}: missing required metadata (id or title)`);
            return null;
        }

        return metadata;
    } catch (error) {
        console.error(`âŒ Error processing ${htmlPath}:`, error.message);
        return null;
    }
}

/**
 * Recursively scan directory for HTML files
 */
function scanDirectory(dir, results = []) {
    const files = fs.readdirSync(dir);

    for (const file of files) {
        const filePath = path.join(dir, file);
        const stat = fs.statSync(filePath);

        if (stat.isDirectory()) {
            // Skip node_modules, .git, etc.
            if (!file.startsWith('.') && file !== 'node_modules' && file !== 'archive') {
                scanDirectory(filePath, results);
            }
        } else if (file.endsWith('.html')) {
            results.push(filePath);
        }
    }

    return results;
}

/**
 * Generate demos config from all HTML files
 */
function generateDemosConfig() {
    console.log('ðŸ” Scanning for demo files...\n');

    const demos = [];
    const scannedPaths = new Set();

    // Scan configured paths
    for (const demoPath of DEMO_PATHS) {
        const fullPath = path.join(PROJECT_ROOT, demoPath);
        if (!fs.existsSync(fullPath)) continue;

        const htmlFiles = scanDirectory(fullPath);

        for (const htmlFile of htmlFiles) {
            // Skip if already scanned (avoid duplicates)
            if (scannedPaths.has(htmlFile)) continue;
            scannedPaths.add(htmlFile);

            const metadata = extractDemoMetadata(htmlFile);
            if (metadata) {
                demos.push(metadata);
                console.log(`âœ… Found demo: ${metadata.title} (${metadata.path})`);
            }
        }
    }

    // Sort demos by title
    demos.sort((a, b) => a.title.localeCompare(b.title));

    // Create config object
    const config = {
        "$schema": "https://json-schema.org/draft-07/schema#",
        "$comment": "Auto-generated by scripts/generate-demos-config.js - DO NOT EDIT MANUALLY",
        "version": "1.0",
        "lastUpdated": new Date().toISOString(),
        "description": "Registry of interactive HTML demonstrations showcasing The Matrix capabilities",
        "demos": demos
    };

    // Ensure output directory exists
    const outputDir = path.dirname(OUTPUT_FILE);
    if (!fs.existsSync(outputDir)) {
        fs.mkdirSync(outputDir, { recursive: true });
    }

    // Write config file
    fs.writeFileSync(OUTPUT_FILE, JSON.stringify(config, null, 2));

    console.log(`\nâœ… Generated ${OUTPUT_FILE}`);
    console.log(`ðŸ“Š Found ${demos.length} demo(s)\n`);

    return demos;
}

// Run if called directly
if (require.main === module) {
    generateDemosConfig();
}

module.exports = { generateDemosConfig };
